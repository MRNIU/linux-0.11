<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>linux: /home/runner/work/linux-0.11/linux-0.11/src/kernel/math/math_emulate.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">linux
   &#160;<span id="projectnumber">0.11</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('src_2kernel_2math_2math__emulate_8c_source.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">math_emulate.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="src_2kernel_2math_2math__emulate_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> * linux/kernel/math/math_emulate.c</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> * (C) 1991 Linus Torvalds</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160; </div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160; </div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">// This directory should contain the math-emulation code.</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// Currently only results in a signal.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// 该目录里应该包含数学仿真代码。目前仅产生一个信号。</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160; </div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="preprocessor">#include &lt;signal.h&gt;</span> <span class="comment">// 信号头文件。定义信号符号常量，信号结构以及信号曹走函数原型</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160; </div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#include &lt;linux/sched.h&gt;</span>  <span class="comment">// 调度程序头文件，定义了任务结构 task_struct、初始任务 0 的数据</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;                          <span class="comment">// 还有一些有关描述符参数设置和获取的嵌入式汇编函数宏语句</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &lt;linux/kernel.h&gt;</span> <span class="comment">// 内核头文件。含有一些内核常用函数的原形定义</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &lt;asm/segment.h&gt;</span>  <span class="comment">// 段操作头文件。定义了有关段寄存器操作的嵌入式汇编函数</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160; </div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment">// 协处理器仿真函数。中断处理程序调用的 C 函数，参见(kernel/math/system_call.s,165 行)</span></div>
<div class="line"><a name="l00020"></a><span class="lineno"><a class="line" href="src_2kernel_2math_2math__emulate_8c.html#a6921995b5790cbfb7c0a6374321216bf">   20</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="flash_2Linux-0_811_2kernel_2math_2math__emulate_8c.html#a6921995b5790cbfb7c0a6374321216bf">math_emulate</a>(<span class="keywordtype">long</span> edi, <span class="keywordtype">long</span> esi, <span class="keywordtype">long</span> ebp, <span class="keywordtype">long</span> sys_call_ret,</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;    <span class="keywordtype">long</span> eax,<span class="keywordtype">long</span> ebx,<span class="keywordtype">long</span> ecx,<span class="keywordtype">long</span> edx,</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> fs,<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> es,<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> ds,</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> eip,<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> cs,<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> eflags,</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> ss, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> esp)</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;{</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> first, second;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160; </div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment">// 0x0007 means user code space 表示用户代码空间</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment">// 选择符 0x000F 表示在局部描述符表中描述符索引值=1，即代码空间。如果段寄存器 cs 不等于 0x000F，</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment">// 则表示 cs 一定是内核代码选择符，是在内核代码空间，则出错，显示此时的 cs:eip 值，并显示</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment">// 信息“内核中需要数学仿真”，然后进入死机状态</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;    <span class="keywordflow">if</span> (cs != 0x000F) {</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;        <a class="code" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#a929c48d2c61fe71be34a9cdf0ab04fcc">printk</a>(<span class="stringliteral">&quot;math_emulate: %04x:%08x\n\r&quot;</span>,cs,eip);</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;        <a class="code" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#ab43c5eded9a063f60e583332eaa73258">panic</a>(<span class="stringliteral">&quot;Math emulation needed in kernel&quot;</span>);</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;    }</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment">// 取进程 cs,eip 指向的 2 字节代码 first 和 secind,显示这些数据，并给进程设置浮点异常信号 SIGFPE</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;    first = <a class="code" href="flash_2Linux-0_811_2include_2asm_2segment_8h.html#a5f273be4f36ebf76067d04592954aaf4">get_fs_byte</a>((<span class="keywordtype">char</span> *)((*&amp;eip)++));</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;    second = <a class="code" href="flash_2Linux-0_811_2include_2asm_2segment_8h.html#a5f273be4f36ebf76067d04592954aaf4">get_fs_byte</a>((<span class="keywordtype">char</span> *)((*&amp;eip)++));</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;    <a class="code" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#a929c48d2c61fe71be34a9cdf0ab04fcc">printk</a>(<span class="stringliteral">&quot;%04x:%08x %02x %02x\n\r&quot;</span>,cs,eip-2,first,second);</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    <a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#a52bf129480ad1720d6672e94a8736b56">signal</a> |= 1&lt;&lt;(<a class="code" href="flash_2Linux-0_811_2include_2signal_8h.html#a7fbba29aec3e4a8daae12935299df92d">SIGFPE</a>-1);</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;}</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160; </div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="comment">// 协处理器出错处理函数。终端处理程序调用的 C 函数，参见(kernel/system_call.s,151)</span></div>
<div class="line"><a name="l00044"></a><span class="lineno"><a class="line" href="src_2kernel_2math_2math__emulate_8c.html#a907b39e81b197f885244ad8e87942750">   44</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="flash_2Linux-0_811_2kernel_2math_2math__emulate_8c.html#a907b39e81b197f885244ad8e87942750">math_error</a>(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;{</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="comment">// 协处理器指令。(以非等待形式)清除所有异常标志、忙标志和状态字位 7</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    __asm__(<span class="stringliteral">&quot;fnclex&quot;</span>);</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="comment">// 如果上个任务使用过协处理器，则向上个任务发送协处理器异常信号</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a4a720faae9986c1917541956019c8a3b">last_task_used_math</a>)</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;        <a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a4a720faae9986c1917541956019c8a3b">last_task_used_math</a>-&gt;<a class="code" href="structtask__struct.html#a52bf129480ad1720d6672e94a8736b56">signal</a> |= 1&lt;&lt;(<a class="code" href="flash_2Linux-0_811_2include_2signal_8h.html#a7fbba29aec3e4a8daae12935299df92d">SIGFPE</a>-1);</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;}</div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2asm_2segment_8h_html_a5f273be4f36ebf76067d04592954aaf4"><div class="ttname"><a href="flash_2Linux-0_811_2include_2asm_2segment_8h.html#a5f273be4f36ebf76067d04592954aaf4">get_fs_byte</a></div><div class="ttdeci">static unsigned char get_fs_byte(const char *addr)</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2asm_2segment_8h_source.html#l00001">segment.h:1</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2linux_2kernel_8h_html_a929c48d2c61fe71be34a9cdf0ab04fcc"><div class="ttname"><a href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#a929c48d2c61fe71be34a9cdf0ab04fcc">printk</a></div><div class="ttdeci">int printk(const char *fmt,...)</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2kernel_2printk_8c_source.html#l00021">printk.c:21</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2linux_2kernel_8h_html_ab43c5eded9a063f60e583332eaa73258"><div class="ttname"><a href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#ab43c5eded9a063f60e583332eaa73258">panic</a></div><div class="ttdeci">volatile void panic(const char *str)</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2kernel_2panic_8c_source.html#l00018">panic.c:18</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2linux_2sched_8h_html_a476ec09a598028a09942c2233aa5127e"><div class="ttname"><a href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a></div><div class="ttdeci">struct task_struct * current</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2kernel_2sched_8c_source.html#l00062">sched.c:62</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2linux_2sched_8h_html_a4a720faae9986c1917541956019c8a3b"><div class="ttname"><a href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a4a720faae9986c1917541956019c8a3b">last_task_used_math</a></div><div class="ttdeci">struct task_struct * last_task_used_math</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2kernel_2sched_8c_source.html#l00063">sched.c:63</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2signal_8h_html_a7fbba29aec3e4a8daae12935299df92d"><div class="ttname"><a href="flash_2Linux-0_811_2include_2signal_8h.html#a7fbba29aec3e4a8daae12935299df92d">SIGFPE</a></div><div class="ttdeci">#define SIGFPE</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2signal_8h_source.html#l00020">signal.h:20</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2kernel_2math_2math__emulate_8c_html_a6921995b5790cbfb7c0a6374321216bf"><div class="ttname"><a href="flash_2Linux-0_811_2kernel_2math_2math__emulate_8c.html#a6921995b5790cbfb7c0a6374321216bf">math_emulate</a></div><div class="ttdeci">void math_emulate(long edi, long esi, long ebp, long sys_call_ret, long eax, long ebx, long ecx, long edx, unsigned short fs, unsigned short es, unsigned short ds, unsigned long eip, unsigned short cs, unsigned long eflags, unsigned short ss, unsigned long esp)</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2kernel_2math_2math__emulate_8c_source.html#l00018">math_emulate.c:18</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2kernel_2math_2math__emulate_8c_html_a907b39e81b197f885244ad8e87942750"><div class="ttname"><a href="flash_2Linux-0_811_2kernel_2math_2math__emulate_8c.html#a907b39e81b197f885244ad8e87942750">math_error</a></div><div class="ttdeci">void math_error(void)</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2kernel_2math_2math__emulate_8c_source.html#l00037">math_emulate.c:37</a></div></div>
<div class="ttc" id="astructtask__struct_html_a52bf129480ad1720d6672e94a8736b56"><div class="ttname"><a href="structtask__struct.html#a52bf129480ad1720d6672e94a8736b56">task_struct::signal</a></div><div class="ttdeci">long signal</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2sched_8h_source.html#l00085">sched.h:85</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_cbd7f246bdf7dc0a50281a272327e6ed.html">kernel</a></li><li class="navelem"><a class="el" href="dir_4017e855267c95e8360f0c3deb2acb14.html">math</a></li><li class="navelem"><a class="el" href="src_2kernel_2math_2math__emulate_8c.html">math_emulate.c</a></li>
    <li class="footer">Generated on Fri Sep 8 2023 09:28:17 for linux by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
