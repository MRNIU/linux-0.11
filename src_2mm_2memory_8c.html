<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>linux: /home/runner/work/linux-0.11/linux-0.11/src/mm/memory.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">linux
   &#160;<span id="projectnumber">0.11</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('src_2mm_2memory_8c.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">memory.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;signal.h&gt;</code><br />
<code>#include &lt;asm/system.h&gt;</code><br />
<code>#include &lt;linux/sched.h&gt;</code><br />
<code>#include &lt;linux/head.h&gt;</code><br />
<code>#include &lt;linux/kernel.h&gt;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for memory.c:</div>
<div class="dyncontent">
<div class="center"><img src="src_2mm_2memory_8c__incl.png" border="0" usemap="#a_2home_2runner_2work_2linux-0_811_2linux-0_811_2src_2mm_2memory_8c" alt=""/></div>
<map name="a_2home_2runner_2work_2linux-0_811_2linux-0_811_2src_2mm_2memory_8c" id="a_2home_2runner_2work_2linux-0_811_2linux-0_811_2src_2mm_2memory_8c">
<area shape="rect" title=" " alt="" coords="206,5,387,61"/>
<area shape="rect" title=" " alt="" coords="5,109,79,136"/>
<area shape="rect" title=" " alt="" coords="103,109,218,136"/>
<area shape="rect" title=" " alt="" coords="243,109,351,136"/>
<area shape="rect" title=" " alt="" coords="375,109,477,136"/>
<area shape="rect" title=" " alt="" coords="501,109,612,136"/>
</map>
</div>
</div>
<p><a href="src_2mm_2memory_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:acf7d1d4e3ad496402dd3b5fbe365105d"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="src_2mm_2memory_8c.html#acf7d1d4e3ad496402dd3b5fbe365105d">invalidate</a>()&#160;&#160;&#160;__asm__(&quot;movl %%eax,%%cr3&quot;:: &quot;<a class="el" href="src_2kernel_2sched_8c.html#a528b92115c4bb60d7b46de7e09ea0bae">a</a>&quot;(0))</td></tr>
<tr class="separator:acf7d1d4e3ad496402dd3b5fbe365105d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a33546c633e25fbc31ba28c4419b37af4"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="src_2mm_2memory_8c.html#a33546c633e25fbc31ba28c4419b37af4">LOW_MEM</a>&#160;&#160;&#160;0x100000</td></tr>
<tr class="separator:a33546c633e25fbc31ba28c4419b37af4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a844080badc1d25259ebc7b7dd46251a4"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="src_2mm_2memory_8c.html#a844080badc1d25259ebc7b7dd46251a4">PAGING_MEMORY</a>&#160;&#160;&#160;(15*1024*1024)</td></tr>
<tr class="separator:a844080badc1d25259ebc7b7dd46251a4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1843924b1500f8e01c5fc255b02088d2"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="src_2mm_2memory_8c.html#a1843924b1500f8e01c5fc255b02088d2">PAGING_PAGES</a>&#160;&#160;&#160;(<a class="el" href="src_2mm_2memory_8c.html#a844080badc1d25259ebc7b7dd46251a4">PAGING_MEMORY</a>&gt;&gt;12)</td></tr>
<tr class="separator:a1843924b1500f8e01c5fc255b02088d2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5a6ea6599d09c9ce1d393125c30965ca"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="src_2mm_2memory_8c.html#a5a6ea6599d09c9ce1d393125c30965ca">MAP_NR</a>(addr)&#160;&#160;&#160;(((addr)-<a class="el" href="src_2mm_2memory_8c.html#a33546c633e25fbc31ba28c4419b37af4">LOW_MEM</a>)&gt;&gt;12)</td></tr>
<tr class="separator:a5a6ea6599d09c9ce1d393125c30965ca"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abcd0a22ee4346cad5706adb6d2119429"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="src_2mm_2memory_8c.html#abcd0a22ee4346cad5706adb6d2119429">USED</a>&#160;&#160;&#160;100</td></tr>
<tr class="separator:abcd0a22ee4346cad5706adb6d2119429"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7c9b7ceb44098d55b2c89b895c8dd096"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="src_2mm_2memory_8c.html#a7c9b7ceb44098d55b2c89b895c8dd096">CODE_SPACE</a>(addr)</td></tr>
<tr class="separator:a7c9b7ceb44098d55b2c89b895c8dd096"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae2f19afb3504df27b0e517884cd3b549"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="src_2mm_2memory_8c.html#ae2f19afb3504df27b0e517884cd3b549">copy_page</a>(from,  to)&#160;&#160;&#160;__asm__(&quot;cld ; rep ; movsl&quot;:: &quot;S&quot; (from), &quot;D&quot; (to), &quot;c&quot; (1024))</td></tr>
<tr class="separator:ae2f19afb3504df27b0e517884cd3b549"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ad6b4534f17cfa3172ef7d563e8fda5f2"><td class="memItemLeft" align="right" valign="top">volatile void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="src_2mm_2memory_8c.html#ad6b4534f17cfa3172ef7d563e8fda5f2">do_exit</a> (long code)</td></tr>
<tr class="separator:ad6b4534f17cfa3172ef7d563e8fda5f2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8bc8685c6eebde3509bd55c7cf73e6d6"><td class="memItemLeft" align="right" valign="top">static volatile void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="src_2mm_2memory_8c.html#a8bc8685c6eebde3509bd55c7cf73e6d6">oom</a> (void)</td></tr>
<tr class="separator:a8bc8685c6eebde3509bd55c7cf73e6d6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af5beb0578c75971eb353cd8a67e9c042"><td class="memItemLeft" align="right" valign="top">unsigned long&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="src_2mm_2memory_8c.html#af5beb0578c75971eb353cd8a67e9c042">get_free_page</a> (void)</td></tr>
<tr class="separator:af5beb0578c75971eb353cd8a67e9c042"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6b87a284a258fa3893dc88c0fcd6f610"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="src_2mm_2memory_8c.html#a6b87a284a258fa3893dc88c0fcd6f610">free_page</a> (unsigned long addr)</td></tr>
<tr class="separator:a6b87a284a258fa3893dc88c0fcd6f610"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a235add1ba6e02ce735d70348d51b25da"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="src_2mm_2memory_8c.html#a235add1ba6e02ce735d70348d51b25da">free_page_tables</a> (unsigned long from, unsigned long size)</td></tr>
<tr class="separator:a235add1ba6e02ce735d70348d51b25da"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3ff1fa1f4d832c7358ba7a038dbac76c"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="src_2mm_2memory_8c.html#a3ff1fa1f4d832c7358ba7a038dbac76c">copy_page_tables</a> (unsigned long from, unsigned long to, long size)</td></tr>
<tr class="separator:a3ff1fa1f4d832c7358ba7a038dbac76c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ace386d1a75522ad316766aa6e3e9432e"><td class="memItemLeft" align="right" valign="top">unsigned long&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="src_2mm_2memory_8c.html#ace386d1a75522ad316766aa6e3e9432e">put_page</a> (unsigned long page, unsigned long address)</td></tr>
<tr class="separator:ace386d1a75522ad316766aa6e3e9432e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7beb786b07c313c61111c5709391f3d3"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="src_2mm_2memory_8c.html#a7beb786b07c313c61111c5709391f3d3">un_wp_page</a> (unsigned long *table_entry)</td></tr>
<tr class="separator:a7beb786b07c313c61111c5709391f3d3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae513bb80700817ae7751c77ab24121f1"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="src_2mm_2memory_8c.html#ae513bb80700817ae7751c77ab24121f1">do_wp_page</a> (unsigned long error_code, unsigned long address)</td></tr>
<tr class="separator:ae513bb80700817ae7751c77ab24121f1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abe18d0a2e79d311f52c8c127665239d6"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="src_2mm_2memory_8c.html#abe18d0a2e79d311f52c8c127665239d6">write_verify</a> (unsigned long address)</td></tr>
<tr class="separator:abe18d0a2e79d311f52c8c127665239d6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a20080cae3ade9c434c67fedceeed05d5"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="src_2mm_2memory_8c.html#a20080cae3ade9c434c67fedceeed05d5">get_empty_page</a> (unsigned long address)</td></tr>
<tr class="separator:a20080cae3ade9c434c67fedceeed05d5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a03e623dabb773a2c0ae889137428ff8a"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="src_2mm_2memory_8c.html#a03e623dabb773a2c0ae889137428ff8a">try_to_share</a> (unsigned long address, struct <a class="el" href="structtask__struct.html">task_struct</a> *p)</td></tr>
<tr class="separator:a03e623dabb773a2c0ae889137428ff8a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af17736024759f2f67c8a0e92edf49631"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="src_2mm_2memory_8c.html#af17736024759f2f67c8a0e92edf49631">share_page</a> (unsigned long address)</td></tr>
<tr class="separator:af17736024759f2f67c8a0e92edf49631"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a55531a8e8bf5db98f751b376994ded87"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="src_2mm_2memory_8c.html#a55531a8e8bf5db98f751b376994ded87">do_no_page</a> (unsigned long error_code, unsigned long address)</td></tr>
<tr class="separator:a55531a8e8bf5db98f751b376994ded87"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a570fcb455a6b0459ada06e7825b783f2"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="src_2mm_2memory_8c.html#a570fcb455a6b0459ada06e7825b783f2">mem_init</a> (long start_mem, long end_mem)</td></tr>
<tr class="separator:a570fcb455a6b0459ada06e7825b783f2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a88b0a7f58cf2c9b793979df76ca396dd"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="src_2mm_2memory_8c.html#a88b0a7f58cf2c9b793979df76ca396dd">calc_mem</a> (void)</td></tr>
<tr class="separator:a88b0a7f58cf2c9b793979df76ca396dd"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a9838fae7bc8607f03ff29cfd191441c7"><td class="memItemLeft" align="right" valign="top">static long&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="src_2mm_2memory_8c.html#a9838fae7bc8607f03ff29cfd191441c7">HIGH_MEMORY</a> = 0</td></tr>
<tr class="separator:a9838fae7bc8607f03ff29cfd191441c7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a55d0a3018dfecd08963844523d3d4b64"><td class="memItemLeft" align="right" valign="top">static unsigned char&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="src_2mm_2memory_8c.html#a55d0a3018dfecd08963844523d3d4b64">mem_map</a> [<a class="el" href="src_2mm_2memory_8c.html#a1843924b1500f8e01c5fc255b02088d2">PAGING_PAGES</a>] = {0,}</td></tr>
<tr class="separator:a55d0a3018dfecd08963844523d3d4b64"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Macro Definition Documentation</h2>
<a id="a7c9b7ceb44098d55b2c89b895c8dd096"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7c9b7ceb44098d55b2c89b895c8dd096">&#9670;&nbsp;</a></span>CODE_SPACE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define CODE_SPACE</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">addr</td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">((((addr)+4095)&amp;~4095) &lt; \</div>
<div class="line"><a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#a24d9b9a967501adbc9ef96dde3ae3cbd">start_code</a> + <a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#a5e6e5b2699bb0d77f87d4b677b6df851">end_code</a>)</div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2linux_2sched_8h_html_a476ec09a598028a09942c2233aa5127e"><div class="ttname"><a href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a></div><div class="ttdeci">struct task_struct * current</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2kernel_2sched_8c_source.html#l00062">sched.c:62</a></div></div>
<div class="ttc" id="astructtask__struct_html_a24d9b9a967501adbc9ef96dde3ae3cbd"><div class="ttname"><a href="structtask__struct.html#a24d9b9a967501adbc9ef96dde3ae3cbd">task_struct::start_code</a></div><div class="ttdeci">unsigned long start_code</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2sched_8h_source.html#l00090">sched.h:90</a></div></div>
<div class="ttc" id="astructtask__struct_html_a5e6e5b2699bb0d77f87d4b677b6df851"><div class="ttname"><a href="structtask__struct.html#a5e6e5b2699bb0d77f87d4b677b6df851">task_struct::end_code</a></div><div class="ttdeci">unsigned long end_code</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2sched_8h_source.html#l00090">sched.h:90</a></div></div>
</div><!-- fragment -->
<p class="definition">Definition at line <a class="el" href="src_2mm_2memory_8c_source.html#l00060">60</a> of file <a class="el" href="src_2mm_2memory_8c_source.html">memory.c</a>.</p>

</div>
</div>
<a id="ae2f19afb3504df27b0e517884cd3b549"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae2f19afb3504df27b0e517884cd3b549">&#9670;&nbsp;</a></span>copy_page</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define copy_page</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">from, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">to&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td>&#160;&#160;&#160;__asm__(&quot;cld ; rep ; movsl&quot;:: &quot;S&quot; (from), &quot;D&quot; (to), &quot;c&quot; (1024))</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="src_2mm_2memory_8c_source.html#l00066">66</a> of file <a class="el" href="src_2mm_2memory_8c_source.html">memory.c</a>.</p>

</div>
</div>
<a id="acf7d1d4e3ad496402dd3b5fbe365105d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#acf7d1d4e3ad496402dd3b5fbe365105d">&#9670;&nbsp;</a></span>invalidate</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define invalidate</td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td>&#160;&#160;&#160;__asm__(&quot;movl %%eax,%%cr3&quot;:: &quot;<a class="el" href="src_2kernel_2sched_8c.html#a528b92115c4bb60d7b46de7e09ea0bae">a</a>&quot;(0))</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="src_2mm_2memory_8c_source.html#l00046">46</a> of file <a class="el" href="src_2mm_2memory_8c_source.html">memory.c</a>.</p>

</div>
</div>
<a id="a33546c633e25fbc31ba28c4419b37af4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a33546c633e25fbc31ba28c4419b37af4">&#9670;&nbsp;</a></span>LOW_MEM</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define LOW_MEM&#160;&#160;&#160;0x100000</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="src_2mm_2memory_8c_source.html#l00052">52</a> of file <a class="el" href="src_2mm_2memory_8c_source.html">memory.c</a>.</p>

</div>
</div>
<a id="a5a6ea6599d09c9ce1d393125c30965ca"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5a6ea6599d09c9ce1d393125c30965ca">&#9670;&nbsp;</a></span>MAP_NR</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MAP_NR</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">addr</td><td>)</td>
          <td>&#160;&#160;&#160;(((addr)-<a class="el" href="src_2mm_2memory_8c.html#a33546c633e25fbc31ba28c4419b37af4">LOW_MEM</a>)&gt;&gt;12)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="src_2mm_2memory_8c_source.html#l00055">55</a> of file <a class="el" href="src_2mm_2memory_8c_source.html">memory.c</a>.</p>

</div>
</div>
<a id="a844080badc1d25259ebc7b7dd46251a4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a844080badc1d25259ebc7b7dd46251a4">&#9670;&nbsp;</a></span>PAGING_MEMORY</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define PAGING_MEMORY&#160;&#160;&#160;(15*1024*1024)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="src_2mm_2memory_8c_source.html#l00053">53</a> of file <a class="el" href="src_2mm_2memory_8c_source.html">memory.c</a>.</p>

</div>
</div>
<a id="a1843924b1500f8e01c5fc255b02088d2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1843924b1500f8e01c5fc255b02088d2">&#9670;&nbsp;</a></span>PAGING_PAGES</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define PAGING_PAGES&#160;&#160;&#160;(<a class="el" href="src_2mm_2memory_8c.html#a844080badc1d25259ebc7b7dd46251a4">PAGING_MEMORY</a>&gt;&gt;12)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="src_2mm_2memory_8c_source.html#l00054">54</a> of file <a class="el" href="src_2mm_2memory_8c_source.html">memory.c</a>.</p>

</div>
</div>
<a id="abcd0a22ee4346cad5706adb6d2119429"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abcd0a22ee4346cad5706adb6d2119429">&#9670;&nbsp;</a></span>USED</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define USED&#160;&#160;&#160;100</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="src_2mm_2memory_8c_source.html#l00056">56</a> of file <a class="el" href="src_2mm_2memory_8c_source.html">memory.c</a>.</p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="a88b0a7f58cf2c9b793979df76ca396dd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a88b0a7f58cf2c9b793979df76ca396dd">&#9670;&nbsp;</a></span>calc_mem()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void calc_mem </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="src_2mm_2memory_8c_source.html#l00588">588</a> of file <a class="el" href="src_2mm_2memory_8c_source.html">memory.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;                    {</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;    <span class="keywordtype">int</span> i, j, k, <a class="code" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a> = 0;</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;    <span class="keywordtype">long</span> *pg_tbl;</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160; </div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;    <span class="comment">// 扫描内存页面映射数组 mem_map[]，获取空闲页面数并显示。</span></div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="src_2mm_2memory_8c.html#a1843924b1500f8e01c5fc255b02088d2">PAGING_PAGES</a>; i++)</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="src_2mm_2memory_8c.html#a55d0a3018dfecd08963844523d3d4b64">mem_map</a>[i])</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;            <a class="code" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>++;</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;    <a class="code" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#a929c48d2c61fe71be34a9cdf0ab04fcc">printk</a>(<span class="stringliteral">&quot;%d pages free (of %d)\n\r&quot;</span>, <a class="code" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>, <a class="code" href="src_2mm_2memory_8c.html#a1843924b1500f8e01c5fc255b02088d2">PAGING_PAGES</a>);</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;    <span class="comment">// 扫描所有页目录项（除0，1 项），如果页目录项有效，则统计对应页表中有效页面数，并显示。</span></div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;    <span class="keywordflow">for</span> (i = 2; i &lt; 1024; i++) {</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;        <span class="keywordflow">if</span> (1 &amp; <a class="code" href="flash_2Linux-0_811_2include_2linux_2head_8h.html#ada02d969a3cb97ba8ac8d43334498cab">pg_dir</a>[i]) {</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;            pg_tbl = (<span class="keywordtype">long</span> *) (0xfffff000 &amp; <a class="code" href="flash_2Linux-0_811_2include_2linux_2head_8h.html#ada02d969a3cb97ba8ac8d43334498cab">pg_dir</a>[i]);</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;            <span class="keywordflow">for</span> (j = k = 0; j &lt; 1024; j++)</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;                <span class="keywordflow">if</span> (pg_tbl[j] &amp; 1)</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;                    k++;</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;            <a class="code" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#a929c48d2c61fe71be34a9cdf0ab04fcc">printk</a>(<span class="stringliteral">&quot;Pg-dir[%d] uses %d pages\n&quot;</span>, i, k);</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;        }</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;    }</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;}</div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2linux_2head_8h_html_ada02d969a3cb97ba8ac8d43334498cab"><div class="ttname"><a href="flash_2Linux-0_811_2include_2linux_2head_8h.html#ada02d969a3cb97ba8ac8d43334498cab">pg_dir</a></div><div class="ttdeci">unsigned long pg_dir[1024]</div></div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2linux_2kernel_8h_html_a929c48d2c61fe71be34a9cdf0ab04fcc"><div class="ttname"><a href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#a929c48d2c61fe71be34a9cdf0ab04fcc">printk</a></div><div class="ttdeci">int printk(const char *fmt,...)</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2kernel_2printk_8c_source.html#l00021">printk.c:21</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2linux_2kernel_8h_html_affb9fc32698fab7f7b36e0cf8e64c83e"><div class="ttname"><a href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a></div><div class="ttdeci">#define free(x)</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2kernel_8h_source.html#l00012">kernel.h:12</a></div></div>
<div class="ttc" id="asrc_2mm_2memory_8c_html_a1843924b1500f8e01c5fc255b02088d2"><div class="ttname"><a href="src_2mm_2memory_8c.html#a1843924b1500f8e01c5fc255b02088d2">PAGING_PAGES</a></div><div class="ttdeci">#define PAGING_PAGES</div><div class="ttdef"><b>Definition:</b> <a href="src_2mm_2memory_8c_source.html#l00054">memory.c:54</a></div></div>
<div class="ttc" id="asrc_2mm_2memory_8c_html_a55d0a3018dfecd08963844523d3d4b64"><div class="ttname"><a href="src_2mm_2memory_8c.html#a55d0a3018dfecd08963844523d3d4b64">mem_map</a></div><div class="ttdeci">static unsigned char mem_map[PAGING_PAGES]</div><div class="ttdef"><b>Definition:</b> <a href="src_2mm_2memory_8c_source.html#l00070">memory.c:70</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="src_2mm_2memory_8c_a88b0a7f58cf2c9b793979df76ca396dd_cgraph.png" border="0" usemap="#asrc_2mm_2memory_8c_a88b0a7f58cf2c9b793979df76ca396dd_cgraph" alt=""/></div>
<map name="asrc_2mm_2memory_8c_a88b0a7f58cf2c9b793979df76ca396dd_cgraph" id="asrc_2mm_2memory_8c_a88b0a7f58cf2c9b793979df76ca396dd_cgraph">
<area shape="rect" title=" " alt="" coords="5,56,95,83"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#a929c48d2c61fe71be34a9cdf0ab04fcc" title=" " alt="" coords="143,56,203,83"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2printk_8c.html#aaa83f2a89dae6d03dfe15deae29f383a" title=" " alt="" coords="251,56,323,83"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#ac2f4c669c6f6aa6caa5ab8adb1b07dd0" title=" " alt="" coords="375,5,447,32"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#a3fa7c8ef8597579301cb4b5c59bc6d9a" title=" " alt="" coords="371,56,452,83"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2string_8h.html#a2dee044e4e667b5b789b493abd21cfa4" title=" " alt="" coords="382,107,441,133"/>
</map>
</div>

</div>
</div>
<a id="a3ff1fa1f4d832c7358ba7a038dbac76c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3ff1fa1f4d832c7358ba7a038dbac76c">&#9670;&nbsp;</a></span>copy_page_tables()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int copy_page_tables </td>
          <td>(</td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>from</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>to</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">long&#160;</td>
          <td class="paramname"><em>size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="src_2mm_2memory_8c_source.html#l00208">208</a> of file <a class="el" href="src_2mm_2memory_8c_source.html">memory.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;                                                                      {</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *from_page_table;</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *to_page_table;</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> this_page;</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *from_dir, *to_dir;</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> nr;</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160; </div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    <span class="comment">// 源地址和目的地址都需要是在 4Mb 的内存边界地址上。否则出错，死机。</span></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    <span class="keywordflow">if</span> ((from &amp; 0x3fffff) || (to &amp; 0x3fffff))</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;        <a class="code" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#ab43c5eded9a063f60e583332eaa73258">panic</a>(<span class="stringliteral">&quot;copy_page_tables called with wrong alignment&quot;</span>);</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    <span class="comment">// 取得源地址和目的地址的目录项(from_dir 和 to_dir)。参见对 22222 句的注释。</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    from_dir = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *) ((from &gt;&gt; 20) &amp; 0xffc);    <span class="comment">// _pg_dir = 0</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    to_dir = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *) ((to &gt;&gt; 20) &amp; 0xffc);</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <span class="comment">// 计算要复制的内存块占用的页表数（也即目录项数）。</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    size = ((unsigned) (size + 0x3fffff)) &gt;&gt; 22;</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    <span class="comment">// 下面开始对每个占用的页表依次进行复制操作。</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    <span class="keywordflow">for</span> (; size-- &gt; 0; from_dir++, to_dir++) {</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;        <span class="comment">// 如果目的目录项指定的页表已经存在(P=1)，则出错，死机。</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        <span class="keywordflow">if</span> (1 &amp; *to_dir)</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;            <a class="code" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#ab43c5eded9a063f60e583332eaa73258">panic</a>(<span class="stringliteral">&quot;copy_page_tables: already exist&quot;</span>);</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;        <span class="comment">// 如果此源目录项未被使用，则不用复制对应页表，跳过。</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;        <span class="keywordflow">if</span> (!(1 &amp; *from_dir))</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;        <span class="comment">// 取当前源目录项中页表的地址-&gt; from_page_table。</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;        from_page_table = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *) (0xfffff000 &amp; *from_dir);</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;        <span class="comment">// 为目的页表取一页空闲内存，如果返回是 0 则说明没有申请到空闲内存页面。返回值= -1，退出。</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;        <span class="keywordflow">if</span> (!(to_page_table = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *) <a class="code" href="flash_2Linux-0_811_2mm_2memory_8c.html#af5beb0578c75971eb353cd8a67e9c042">get_free_page</a>()))</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;            <span class="keywordflow">return</span> -1;        <span class="comment">/* Out of memory, see freeing */</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;        <span class="comment">// 设置目的目录项信息。7 是标志信息，表示(Usr, R/W, Present)。</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;        *to_dir = ((<span class="keywordtype">unsigned</span> long) to_page_table) | 7;</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;        <span class="comment">// 针对当前处理的页表，设置需复制的页面数。如果是在内核空间，则仅需复制头 160 页，否则需要</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;        <span class="comment">// 复制 1 个页表中的所有 1024 页面。</span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;        nr = (from == 0) ? 0xA0 : 1024;</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;        <span class="comment">// 对于当前页表，开始复制指定数目 nr 个内存页面。</span></div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;        <span class="keywordflow">for</span> (; nr-- &gt; 0; from_page_table++, to_page_table++) {</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;            this_page = *from_page_table;    <span class="comment">// 取源页表项内容。</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;            <span class="keywordflow">if</span> (!(1 &amp; this_page))    <span class="comment">// 如果当前源页面没有使用，则不用复制。</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;                <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;            <span class="comment">// 复位页表项中 R/W 标志(置 0)。(如果 U/S 位是 0，则 R/W 就没有作用。如果 U/S 是 1，而 R/W 是 0，</span></div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;            <span class="comment">// 那么运行在用户层的代码就只能读页面。如果 U/S 和 R/W 都置位，则就有写的权限。)</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;            this_page &amp;= ~2;</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;            *to_page_table = this_page;    <span class="comment">// 将该页表项复制到目的页表中。</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;            <span class="comment">// 如果该页表项所指页面的地址在 1M 以上，则需要设置内存页面映射数组 mem_map[]，于是计算</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;            <span class="comment">// 页面号，并以它为索引在页面映射数组相应项中增加引用次数。</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;            <span class="keywordflow">if</span> (this_page &gt; <a class="code" href="src_2mm_2memory_8c.html#a33546c633e25fbc31ba28c4419b37af4">LOW_MEM</a>) {</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;                <span class="comment">// 下面这句的含义是令源页表项所指内存页也为只读。因为现在开始有两个进程共用内存区了。</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;                <span class="comment">// 若其中一个内存需要进行写操作，则可以通过页异常的写保护处理，为执行写操作的进程分配</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                <span class="comment">// 一页新的空闲页面，也即进行写时复制的操作。</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                *from_page_table = this_page;    <span class="comment">// 令源页表项也只读。</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;                this_page -= <a class="code" href="src_2mm_2memory_8c.html#a33546c633e25fbc31ba28c4419b37af4">LOW_MEM</a>;</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;                this_page &gt;&gt;= 12;</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;                <a class="code" href="src_2mm_2memory_8c.html#a55d0a3018dfecd08963844523d3d4b64">mem_map</a>[this_page]++;</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;            }</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;        }</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    }</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    <a class="code" href="src_2mm_2memory_8c.html#acf7d1d4e3ad496402dd3b5fbe365105d">invalidate</a>();        <span class="comment">// 刷新页变换高速缓冲。</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;}</div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2linux_2kernel_8h_html_ab43c5eded9a063f60e583332eaa73258"><div class="ttname"><a href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#ab43c5eded9a063f60e583332eaa73258">panic</a></div><div class="ttdeci">volatile void panic(const char *str)</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2kernel_2panic_8c_source.html#l00018">panic.c:18</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2mm_2memory_8c_html_af5beb0578c75971eb353cd8a67e9c042"><div class="ttname"><a href="flash_2Linux-0_811_2mm_2memory_8c.html#af5beb0578c75971eb353cd8a67e9c042">get_free_page</a></div><div class="ttdeci">unsigned long get_free_page(void)</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2mm_2memory_8c_source.html#l00063">memory.c:63</a></div></div>
<div class="ttc" id="asrc_2mm_2memory_8c_html_a33546c633e25fbc31ba28c4419b37af4"><div class="ttname"><a href="src_2mm_2memory_8c.html#a33546c633e25fbc31ba28c4419b37af4">LOW_MEM</a></div><div class="ttdeci">#define LOW_MEM</div><div class="ttdef"><b>Definition:</b> <a href="src_2mm_2memory_8c_source.html#l00052">memory.c:52</a></div></div>
<div class="ttc" id="asrc_2mm_2memory_8c_html_acf7d1d4e3ad496402dd3b5fbe365105d"><div class="ttname"><a href="src_2mm_2memory_8c.html#acf7d1d4e3ad496402dd3b5fbe365105d">invalidate</a></div><div class="ttdeci">#define invalidate()</div><div class="ttdef"><b>Definition:</b> <a href="src_2mm_2memory_8c_source.html#l00046">memory.c:46</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="src_2mm_2memory_8c_a3ff1fa1f4d832c7358ba7a038dbac76c_cgraph.png" border="0" usemap="#asrc_2mm_2memory_8c_a3ff1fa1f4d832c7358ba7a038dbac76c_cgraph" alt=""/></div>
<map name="asrc_2mm_2memory_8c_a3ff1fa1f4d832c7358ba7a038dbac76c_cgraph" id="asrc_2mm_2memory_8c_a3ff1fa1f4d832c7358ba7a038dbac76c_cgraph">
<area shape="rect" title=" " alt="" coords="5,56,144,83"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#af5beb0578c75971eb353cd8a67e9c042" title=" " alt="" coords="192,31,307,57"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#ab43c5eded9a063f60e583332eaa73258" title=" " alt="" coords="221,81,278,108"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#a929c48d2c61fe71be34a9cdf0ab04fcc" title=" " alt="" coords="365,56,425,83"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2panic_8c.html#acc81aedafa96378bafb37b5bccbccb20" title=" " alt="" coords="355,107,436,133"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2printk_8c.html#aaa83f2a89dae6d03dfe15deae29f383a" title=" " alt="" coords="484,56,556,83"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#ac2f4c669c6f6aa6caa5ab8adb1b07dd0" title=" " alt="" coords="609,5,681,32"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#a3fa7c8ef8597579301cb4b5c59bc6d9a" title=" " alt="" coords="604,56,685,83"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2string_8h.html#a2dee044e4e667b5b789b493abd21cfa4" title=" " alt="" coords="615,107,674,133"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="src_2mm_2memory_8c_a3ff1fa1f4d832c7358ba7a038dbac76c_icgraph.png" border="0" usemap="#asrc_2mm_2memory_8c_a3ff1fa1f4d832c7358ba7a038dbac76c_icgraph" alt=""/></div>
<map name="asrc_2mm_2memory_8c_a3ff1fa1f4d832c7358ba7a038dbac76c_icgraph" id="asrc_2mm_2memory_8c_a3ff1fa1f4d832c7358ba7a038dbac76c_icgraph">
<area shape="rect" title=" " alt="" coords="307,5,445,32"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2fork_8c.html#a83662a2300404942511d99c80128deb1" title=" " alt="" coords="164,5,259,32"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2fork_8c.html#ab154f2aa621bc4a2a554496a7eaa59ab" title=" " alt="" coords="5,5,116,32"/>
</map>
</div>

</div>
</div>
<a id="ad6b4534f17cfa3172ef7d563e8fda5f2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad6b4534f17cfa3172ef7d563e8fda5f2">&#9670;&nbsp;</a></span>do_exit()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile void do_exit </td>
          <td>(</td>
          <td class="paramtype">long&#160;</td>
          <td class="paramname"><em>code</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="flash_2Linux-0_811_2kernel_2exit_8c_source.html#l00102">102</a> of file <a class="el" href="flash_2Linux-0_811_2kernel_2exit_8c_source.html">exit.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;{</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    <span class="keywordtype">int</span> i;</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    <a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a235add1ba6e02ce735d70348d51b25da">free_page_tables</a>(<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a9dd1e6646ae18eb198ab5c9882b4f1a0">get_base</a>(<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#a326ff4e561c98dd1d2a23d43d0a42ab6">ldt</a>[1]),<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a17e07a3b0c01ae08bc0fe1136c24a092">get_limit</a>(0x0f));</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    <a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a235add1ba6e02ce735d70348d51b25da">free_page_tables</a>(<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a9dd1e6646ae18eb198ab5c9882b4f1a0">get_base</a>(<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#a326ff4e561c98dd1d2a23d43d0a42ab6">ldt</a>[2]),<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a17e07a3b0c01ae08bc0fe1136c24a092">get_limit</a>(0x17));</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    <span class="keywordflow">for</span> (i=0 ; i&lt;<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a88a8e8596ba6eca6449e368319c9c73d">NR_TASKS</a> ; i++)</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a32ae6a90bd92bba7a7d2103b2b0662d8">task</a>[i] &amp;&amp; <a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a32ae6a90bd92bba7a7d2103b2b0662d8">task</a>[i]-&gt;father == <a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#a192ab89a0e8b299ff3fca4931e331667">pid</a>) {</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;            <a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a32ae6a90bd92bba7a7d2103b2b0662d8">task</a>[i]-&gt;<a class="code" href="structtask__struct.html#a889eead58452db4f8a717d529db3476f">father</a> = 1;</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a32ae6a90bd92bba7a7d2103b2b0662d8">task</a>[i]-&gt;<a class="code" href="flash_2Linux-0_811_2kernel_2chr__drv_2console_8c.html#af7504fc0e249186b115eb5f51a297878">state</a> == <a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a88316d4f858f89f5facc75f0efa1dc74">TASK_ZOMBIE</a>)</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;                <span class="comment">/* assumption task[1] is always init */</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;                (void) <a class="code" href="flash_2Linux-0_811_2kernel_2exit_8c.html#a82fbc5c0a4618748c97050c05ec6473d">send_sig</a>(<a class="code" href="flash_2Linux-0_811_2include_2signal_8h.html#a0e63521a64cc8bc2b91d36a87d32c9f8">SIGCHLD</a>, <a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a32ae6a90bd92bba7a7d2103b2b0662d8">task</a>[1], 1);</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        }</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    <span class="keywordflow">for</span> (i=0 ; i&lt;<a class="code" href="flash_2Linux-0_811_2include_2linux_2fs_8h.html#a326ba885b33e0ac094fec455a1ec30b3">NR_OPEN</a> ; i++)</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#af92b36c90c0636553c690c20ecc9553e">filp</a>[i])</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;            <a class="code" href="flash_2Linux-0_811_2kernel_2exit_8c.html#a9d94cbe3ac3c59ac54d9e884a024d9c5">sys_close</a>(i);</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    <a class="code" href="flash_2Linux-0_811_2fs_2inode_8c.html#afa76e75f45af948cbb6e5da444038f40">iput</a>(<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#a66b96e2cff9937ecdba35d1787a6a099">pwd</a>);</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    <a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#a66b96e2cff9937ecdba35d1787a6a099">pwd</a>=<a class="code" href="flash_2Linux-0_811_2include_2linux_2fs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    <a class="code" href="flash_2Linux-0_811_2fs_2inode_8c.html#afa76e75f45af948cbb6e5da444038f40">iput</a>(<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#a7e465a232e068e5bf74d8b389b8e82ed">root</a>);</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    <a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#a7e465a232e068e5bf74d8b389b8e82ed">root</a>=<a class="code" href="flash_2Linux-0_811_2include_2linux_2fs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    <a class="code" href="flash_2Linux-0_811_2fs_2inode_8c.html#afa76e75f45af948cbb6e5da444038f40">iput</a>(<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#ae07dc9ad85faa82c21f0280346eee331">executable</a>);</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    <a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#ae07dc9ad85faa82c21f0280346eee331">executable</a>=<a class="code" href="flash_2Linux-0_811_2include_2linux_2fs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#a27d1eeb29875216c39bb586fb0b3351e">leader</a> &amp;&amp; <a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#a5bbd97dd49b96e0dfdb883366554538e">tty</a> &gt;= 0)</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;        <a class="code" href="flash_2Linux-0_811_2include_2linux_2tty_8h.html#aa109788d183a1ef0d1e29454236ae332">tty_table</a>[<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#a5bbd97dd49b96e0dfdb883366554538e">tty</a>].<a class="code" href="structtty__struct.html#a70ff434d0bb918d58530f77220f18a1c">pgrp</a> = 0;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a4a720faae9986c1917541956019c8a3b">last_task_used_math</a> == <a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>)</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;        <a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a4a720faae9986c1917541956019c8a3b">last_task_used_math</a> = <a class="code" href="flash_2Linux-0_811_2include_2linux_2fs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#a27d1eeb29875216c39bb586fb0b3351e">leader</a>)</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        <a class="code" href="flash_2Linux-0_811_2kernel_2exit_8c.html#afc059b7e2dc2c4b8dc2767fca9dbced5">kill_session</a>();</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    <a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#a7c764a1b0218921014431825397cdce8">state</a> = <a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a88316d4f858f89f5facc75f0efa1dc74">TASK_ZOMBIE</a>;</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    <a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#ad9da706c569dce6f2cbe25498b7aa96b">exit_code</a> = code;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    <a class="code" href="flash_2Linux-0_811_2kernel_2exit_8c.html#a8ca56e7d5016dbf7a39ef89eeda70be6">tell_father</a>(<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#a889eead58452db4f8a717d529db3476f">father</a>);</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    <a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#ac48128e72b303ea22d8ec641a9516b15">schedule</a>();</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    <span class="keywordflow">return</span> (-1);    <span class="comment">/* just to suppress warnings */</span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;}</div>
<div class="ttc" id="aflash_2Linux-0_811_2fs_2inode_8c_html_afa76e75f45af948cbb6e5da444038f40"><div class="ttname"><a href="flash_2Linux-0_811_2fs_2inode_8c.html#afa76e75f45af948cbb6e5da444038f40">iput</a></div><div class="ttdeci">void iput(struct m_inode *inode)</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2fs_2inode_8c_source.html#l00150">inode.c:150</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2linux_2fs_8h_html_a070d2ce7b6bb7e5c05602aa8c308d0c4"><div class="ttname"><a href="flash_2Linux-0_811_2include_2linux_2fs_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a></div><div class="ttdeci">#define NULL</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2fs_8h_source.html#l00052">fs.h:52</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2linux_2fs_8h_html_a326ba885b33e0ac094fec455a1ec30b3"><div class="ttname"><a href="flash_2Linux-0_811_2include_2linux_2fs_8h.html#a326ba885b33e0ac094fec455a1ec30b3">NR_OPEN</a></div><div class="ttdeci">#define NR_OPEN</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2fs_8h_source.html#l00043">fs.h:43</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2linux_2sched_8h_html_a17e07a3b0c01ae08bc0fe1136c24a092"><div class="ttname"><a href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a17e07a3b0c01ae08bc0fe1136c24a092">get_limit</a></div><div class="ttdeci">#define get_limit(segment)</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2sched_8h_source.html#l00251">sched.h:251</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2linux_2sched_8h_html_a235add1ba6e02ce735d70348d51b25da"><div class="ttname"><a href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a235add1ba6e02ce735d70348d51b25da">free_page_tables</a></div><div class="ttdeci">int free_page_tables(unsigned long from, unsigned long size)</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2mm_2memory_8c_source.html#l00105">memory.c:105</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2linux_2sched_8h_html_a32ae6a90bd92bba7a7d2103b2b0662d8"><div class="ttname"><a href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a32ae6a90bd92bba7a7d2103b2b0662d8">task</a></div><div class="ttdeci">struct task_struct * task[NR_TASKS]</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2kernel_2sched_8c_source.html#l00065">sched.c:65</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2linux_2sched_8h_html_a4a720faae9986c1917541956019c8a3b"><div class="ttname"><a href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a4a720faae9986c1917541956019c8a3b">last_task_used_math</a></div><div class="ttdeci">struct task_struct * last_task_used_math</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2kernel_2sched_8c_source.html#l00063">sched.c:63</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2linux_2sched_8h_html_a88316d4f858f89f5facc75f0efa1dc74"><div class="ttname"><a href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a88316d4f858f89f5facc75f0efa1dc74">TASK_ZOMBIE</a></div><div class="ttdeci">#define TASK_ZOMBIE</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2sched_8h_source.html#l00022">sched.h:22</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2linux_2sched_8h_html_a88a8e8596ba6eca6449e368319c9c73d"><div class="ttname"><a href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a88a8e8596ba6eca6449e368319c9c73d">NR_TASKS</a></div><div class="ttdeci">#define NR_TASKS</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2sched_8h_source.html#l00004">sched.h:4</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2linux_2sched_8h_html_a9dd1e6646ae18eb198ab5c9882b4f1a0"><div class="ttname"><a href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a9dd1e6646ae18eb198ab5c9882b4f1a0">get_base</a></div><div class="ttdeci">#define get_base(ldt)</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2sched_8h_source.html#l00249">sched.h:249</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2linux_2sched_8h_html_ac48128e72b303ea22d8ec641a9516b15"><div class="ttname"><a href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#ac48128e72b303ea22d8ec641a9516b15">schedule</a></div><div class="ttdeci">void schedule(void)</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2kernel_2sched_8c_source.html#l00104">sched.c:104</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2linux_2tty_8h_html_aa109788d183a1ef0d1e29454236ae332"><div class="ttname"><a href="flash_2Linux-0_811_2include_2linux_2tty_8h.html#aa109788d183a1ef0d1e29454236ae332">tty_table</a></div><div class="ttdeci">struct tty_struct tty_table[]</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2kernel_2chr__drv_2tty__io_8c_source.html#l00001">tty_io.c:51</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2signal_8h_html_a0e63521a64cc8bc2b91d36a87d32c9f8"><div class="ttname"><a href="flash_2Linux-0_811_2include_2signal_8h.html#a0e63521a64cc8bc2b91d36a87d32c9f8">SIGCHLD</a></div><div class="ttdeci">#define SIGCHLD</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2signal_8h_source.html#l00029">signal.h:29</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2kernel_2chr__drv_2console_8c_html_af7504fc0e249186b115eb5f51a297878"><div class="ttname"><a href="flash_2Linux-0_811_2kernel_2chr__drv_2console_8c.html#af7504fc0e249186b115eb5f51a297878">state</a></div><div class="ttdeci">static unsigned long state</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2kernel_2chr__drv_2console_8c_source.html#l00074">console.c:74</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2kernel_2exit_8c_html_a82fbc5c0a4618748c97050c05ec6473d"><div class="ttname"><a href="flash_2Linux-0_811_2kernel_2exit_8c.html#a82fbc5c0a4618748c97050c05ec6473d">send_sig</a></div><div class="ttdeci">static int send_sig(long sig, struct task_struct *p, int priv)</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2kernel_2exit_8c_source.html#l00035">exit.c:35</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2kernel_2exit_8c_html_a8ca56e7d5016dbf7a39ef89eeda70be6"><div class="ttname"><a href="flash_2Linux-0_811_2kernel_2exit_8c.html#a8ca56e7d5016dbf7a39ef89eeda70be6">tell_father</a></div><div class="ttdeci">static void tell_father(int pid)</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2kernel_2exit_8c_source.html#l00083">exit.c:83</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2kernel_2exit_8c_html_a9d94cbe3ac3c59ac54d9e884a024d9c5"><div class="ttname"><a href="flash_2Linux-0_811_2kernel_2exit_8c.html#a9d94cbe3ac3c59ac54d9e884a024d9c5">sys_close</a></div><div class="ttdeci">int sys_close(int fd)</div></div>
<div class="ttc" id="aflash_2Linux-0_811_2kernel_2exit_8c_html_afc059b7e2dc2c4b8dc2767fca9dbced5"><div class="ttname"><a href="flash_2Linux-0_811_2kernel_2exit_8c.html#afc059b7e2dc2c4b8dc2767fca9dbced5">kill_session</a></div><div class="ttdeci">static void kill_session(void)</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2kernel_2exit_8c_source.html#l00046">exit.c:46</a></div></div>
<div class="ttc" id="astructtask__struct_html_a192ab89a0e8b299ff3fca4931e331667"><div class="ttname"><a href="structtask__struct.html#a192ab89a0e8b299ff3fca4931e331667">task_struct::pid</a></div><div class="ttdeci">long pid</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2sched_8h_source.html#l00091">sched.h:91</a></div></div>
<div class="ttc" id="astructtask__struct_html_a27d1eeb29875216c39bb586fb0b3351e"><div class="ttname"><a href="structtask__struct.html#a27d1eeb29875216c39bb586fb0b3351e">task_struct::leader</a></div><div class="ttdeci">long leader</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2sched_8h_source.html#l00091">sched.h:91</a></div></div>
<div class="ttc" id="astructtask__struct_html_a326ff4e561c98dd1d2a23d43d0a42ab6"><div class="ttname"><a href="structtask__struct.html#a326ff4e561c98dd1d2a23d43d0a42ab6">task_struct::ldt</a></div><div class="ttdeci">struct desc_struct ldt[3]</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2sched_8h_source.html#l00104">sched.h:106</a></div></div>
<div class="ttc" id="astructtask__struct_html_a5bbd97dd49b96e0dfdb883366554538e"><div class="ttname"><a href="structtask__struct.html#a5bbd97dd49b96e0dfdb883366554538e">task_struct::tty</a></div><div class="ttdeci">int tty</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2sched_8h_source.html#l00098">sched.h:98</a></div></div>
<div class="ttc" id="astructtask__struct_html_a66b96e2cff9937ecdba35d1787a6a099"><div class="ttname"><a href="structtask__struct.html#a66b96e2cff9937ecdba35d1787a6a099">task_struct::pwd</a></div><div class="ttdeci">struct m_inode * pwd</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2sched_8h_source.html#l00100">sched.h:100</a></div></div>
<div class="ttc" id="astructtask__struct_html_a7c764a1b0218921014431825397cdce8"><div class="ttname"><a href="structtask__struct.html#a7c764a1b0218921014431825397cdce8">task_struct::state</a></div><div class="ttdeci">long state</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2sched_8h_source.html#l00082">sched.h:82</a></div></div>
<div class="ttc" id="astructtask__struct_html_a7e465a232e068e5bf74d8b389b8e82ed"><div class="ttname"><a href="structtask__struct.html#a7e465a232e068e5bf74d8b389b8e82ed">task_struct::root</a></div><div class="ttdeci">struct m_inode * root</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2sched_8h_source.html#l00101">sched.h:101</a></div></div>
<div class="ttc" id="astructtask__struct_html_a889eead58452db4f8a717d529db3476f"><div class="ttname"><a href="structtask__struct.html#a889eead58452db4f8a717d529db3476f">task_struct::father</a></div><div class="ttdeci">long father</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2sched_8h_source.html#l00091">sched.h:91</a></div></div>
<div class="ttc" id="astructtask__struct_html_ad9da706c569dce6f2cbe25498b7aa96b"><div class="ttname"><a href="structtask__struct.html#ad9da706c569dce6f2cbe25498b7aa96b">task_struct::exit_code</a></div><div class="ttdeci">int exit_code</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2sched_8h_source.html#l00089">sched.h:89</a></div></div>
<div class="ttc" id="astructtask__struct_html_ae07dc9ad85faa82c21f0280346eee331"><div class="ttname"><a href="structtask__struct.html#ae07dc9ad85faa82c21f0280346eee331">task_struct::executable</a></div><div class="ttdeci">struct m_inode * executable</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2sched_8h_source.html#l00102">sched.h:102</a></div></div>
<div class="ttc" id="astructtask__struct_html_af92b36c90c0636553c690c20ecc9553e"><div class="ttname"><a href="structtask__struct.html#af92b36c90c0636553c690c20ecc9553e">task_struct::filp</a></div><div class="ttdeci">struct file * filp[NR_OPEN]</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2sched_8h_source.html#l00104">sched.h:104</a></div></div>
<div class="ttc" id="astructtty__struct_html_a70ff434d0bb918d58530f77220f18a1c"><div class="ttname"><a href="structtty__struct.html#a70ff434d0bb918d58530f77220f18a1c">tty_struct::pgrp</a></div><div class="ttdeci">int pgrp</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2tty_8h_source.html#l00047">tty.h:47</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="src_2mm_2memory_8c_ad6b4534f17cfa3172ef7d563e8fda5f2_cgraph.png" border="0" usemap="#asrc_2mm_2memory_8c_ad6b4534f17cfa3172ef7d563e8fda5f2_cgraph" alt=""/></div>
<map name="asrc_2mm_2memory_8c_ad6b4534f17cfa3172ef7d563e8fda5f2_cgraph" id="asrc_2mm_2memory_8c_ad6b4534f17cfa3172ef7d563e8fda5f2_cgraph">
<area shape="rect" title=" " alt="" coords="5,1475,76,1501"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a235add1ba6e02ce735d70348d51b25da" title=" " alt="" coords="124,1373,259,1400"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2inode_8c.html#afa76e75f45af948cbb6e5da444038f40" title=" " alt="" coords="168,1019,215,1045"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2exit_8c.html#afc059b7e2dc2c4b8dc2767fca9dbced5" title=" " alt="" coords="142,1424,241,1451"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#ac48128e72b303ea22d8ec641a9516b15" title=" " alt="" coords="453,1525,533,1552"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2exit_8c.html#a82fbc5c0a4618748c97050c05ec6473d" title=" " alt="" coords="152,1525,231,1552"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2exit_8c.html#a9d94cbe3ac3c59ac54d9e884a024d9c5" title=" " alt="" coords="149,1576,234,1603"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2exit_8c.html#a8ca56e7d5016dbf7a39ef89eeda70be6" title=" " alt="" coords="147,1475,236,1501"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#a6b87a284a258fa3893dc88c0fcd6f610" title=" " alt="" coords="307,1373,393,1400"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#ab43c5eded9a063f60e583332eaa73258" title=" " alt="" coords="1638,1069,1695,1096"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#a929c48d2c61fe71be34a9cdf0ab04fcc" title=" " alt="" coords="1765,1196,1825,1223"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2panic_8c.html#acc81aedafa96378bafb37b5bccbccb20" title=" " alt="" coords="1755,1069,1836,1096"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2printk_8c.html#aaa83f2a89dae6d03dfe15deae29f383a" title=" " alt="" coords="1884,1196,1956,1223"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#ac2f4c669c6f6aa6caa5ab8adb1b07dd0" title=" " alt="" coords="2009,1145,2081,1172"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#a3fa7c8ef8597579301cb4b5c59bc6d9a" title=" " alt="" coords="2004,1196,2085,1223"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2string_8h.html#a2dee044e4e667b5b789b493abd21cfa4" title=" " alt="" coords="2015,1247,2074,1273"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2bitmap_8c.html#a3d90ed0df8a21fff7ae1e1a47053e406" title=" " alt="" coords="765,1221,855,1248"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2mm_8h.html#a6b87a284a258fa3893dc88c0fcd6f610" title=" " alt="" coords="449,1373,536,1400"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2buffer_8c.html#a95df8a2e491bf4181e3d7b6ddfc755a3" title=" " alt="" coords="309,309,391,336"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#add6d90b147b8d600062919f0220600f4" title=" " alt="" coords="1457,765,1536,792"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2inode_8c.html#aef87a93dd139de38ca5b9baac78f4ccc" title=" " alt="" coords="592,5,708,32"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2inode_8c.html#a35a7c0ed9f4a491c42318c15ecefd197" title=" " alt="" coords="601,664,699,691"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2truncate_8c.html#a1697df39771f157846a3ef9f46327c23" title=" " alt="" coords="312,943,388,969"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2super_8c.html#a43f836df13a239d2197028d56018edba" title=" " alt="" coords="916,917,1003,944"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2string_8h.html#a24267045b7b471321172ee7ac82f5158" title=" " alt="" coords="921,1272,997,1299"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2super_8c.html#a443c3c886626b03f1130aa6a8758f8ef" title=" " alt="" coords="1069,917,1185,944"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a8ee0eea1a206d256d223fd33292ddb5d" title=" " alt="" coords="1457,309,1537,336"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2sched_8c.html#ac48128e72b303ea22d8ec641a9516b15" title=" " alt="" coords="1627,309,1707,336"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2exec_8c.html#ad90bdec45596b60ad4a6e7fc0d669bd4" title=" " alt="" coords="1098,1272,1157,1299"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2asm_2segment_8h.html#ab949f1c5413544f8204e5a3338655af5" title=" " alt="" coords="1259,1272,1356,1299"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2fs_8h.html#af9add4ad497e3b9eae67e2cbf7cea45e" title=" " alt="" coords="912,664,1007,691"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2inode_8c.html#a4e8b4c0a66f6ea10acdb053c4f4e8c79" title=" " alt="" coords="441,56,544,83"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2buffer_8c.html#a96f49dc697e8292e946ba7680ebecf96" title=" " alt="" coords="1248,360,1367,387"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2blk__drv_2ll__rw__blk_8c.html#ae0d0119949a9c5eed9b1128db4f13674" title=" " alt="" coords="1070,664,1185,691"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2blk__drv_2ll__rw__blk_8c.html#a5b8b5c7e1bfc934cbb8b0b8be2a4acd0" title=" " alt="" coords="1256,613,1359,640"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2blk__drv_2ll__rw__blk_8c.html#a304a48e632da3fd0006aa586f7cc7ca7" title=" " alt="" coords="1260,512,1355,539"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2blk__drv_2ll__rw__blk_8c.html#aee00866ea6c51121a5cabe13ca77c191" title=" " alt="" coords="1252,715,1363,741"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2buffer_8c.html#ad78fac6715f3c28e0cf0522df36a111f" title=" " alt="" coords="781,664,839,691"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2buffer_8c.html#ad15c8296a5599c15736bb9383050eec7" title=" " alt="" coords="928,816,991,843"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2inode_8c.html#afa4df3c26552f5d09c7a0d6b080baf55" title=" " alt="" coords="764,208,856,235"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2inode_8c.html#a349a2c9da0dd73f8e8324143772650d6" title=" " alt="" coords="756,563,864,589"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2buffer_8c.html#a197cebc7bc8d67773a979e92c14b40c0" title=" " alt="" coords="928,309,991,336"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2buffer_8c.html#a6dd8a689596cf17cdaf4dd6eb6c98e8f" title=" " alt="" coords="1262,309,1353,336"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2buffer_8c.html#a26c3be9640a543377e6c6f8d189c83e9" title=" " alt="" coords="1067,360,1188,387"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2buffer_8c.html#aca6ca6f3081c02518e27afc1d833796a" title=" " alt="" coords="1055,208,1200,235"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2buffer_8c.html#a3cc00a803282300ea51f20842322814e" title=" " alt="" coords="1415,360,1579,387"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2bitmap_8c.html#abdd0da83359d6f16a52320c44c41c526" title=" " alt="" coords="765,917,855,944"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2truncate_8c.html#a9127b9c1a0eae2a1f7d5ff723f5d3563" title=" " alt="" coords="451,867,534,893"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2truncate_8c.html#af203200db3c89f320ff91fafa6ff4e98" title=" " alt="" coords="613,867,687,893"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2exit_8c.html#a4b358e49189bbfecc559204d6f1e8694" title=" " alt="" coords="315,1475,385,1501"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="src_2mm_2memory_8c_ad6b4534f17cfa3172ef7d563e8fda5f2_icgraph.png" border="0" usemap="#asrc_2mm_2memory_8c_ad6b4534f17cfa3172ef7d563e8fda5f2_icgraph" alt=""/></div>
<map name="asrc_2mm_2memory_8c_ad6b4534f17cfa3172ef7d563e8fda5f2_icgraph" id="asrc_2mm_2memory_8c_ad6b4534f17cfa3172ef7d563e8fda5f2_icgraph">
<area shape="rect" title=" " alt="" coords="129,5,200,32"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2exec_8c.html#ae8584b188355851cdd6f403cd5df3c12" title=" " alt="" coords="5,5,81,32"/>
</map>
</div>

</div>
</div>
<a id="a55531a8e8bf5db98f751b376994ded87"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a55531a8e8bf5db98f751b376994ded87">&#9670;&nbsp;</a></span>do_no_page()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void do_no_page </td>
          <td>(</td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>error_code</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>address</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="src_2mm_2memory_8c_source.html#l00520">520</a> of file <a class="el" href="src_2mm_2memory_8c_source.html">memory.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;                                                                 {</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;    <span class="keywordtype">int</span> nr[4];</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> tmp;</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> page;</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;    <span class="keywordtype">int</span> block, i;</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160; </div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;    address &amp;= 0xfffff000;    <span class="comment">// 页面地址。</span></div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;<span class="comment">// 首先算出指定线性地址在进程空间中相对于进程基址的偏移长度值。</span></div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;    tmp = address - <a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#a24d9b9a967501adbc9ef96dde3ae3cbd">start_code</a>;</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;<span class="comment">// 若当前进程的 executable 空，或者指定地址超出代码+数据长度，则申请一页物理内存，并映射</span></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;<span class="comment">// 影射到指定的线性地址处。executable 是进程的 i 节点结构。该值为 0，表明进程刚开始设置，</span></div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;<span class="comment">// 需要内存；而指定的线性地址超出代码加数据长度，表明进程在申请新的内存空间，也需要给予。</span></div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;<span class="comment">// 因此就直接调用 get_empty_page() 函数，申请一页物理内存并映射到指定线性地址处即可。</span></div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;<span class="comment">// start_code 是进程代码段地址，end_data 是代码加数据长度。对于 linux 内核，它的代码段和</span></div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;<span class="comment">// 数据段是起始基址是相同的。</span></div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#ae07dc9ad85faa82c21f0280346eee331">executable</a> || tmp &gt;= <a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#ad2bc0934c9dd26a01b156d2a156d7e1b">end_data</a>) {</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;        <a class="code" href="flash_2Linux-0_811_2mm_2memory_8c.html#a20080cae3ade9c434c67fedceeed05d5">get_empty_page</a>(address);</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;    }</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    <span class="comment">// 如果尝试共享页面成功，则退出。</span></div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="src_2mm_2memory_8c.html#af17736024759f2f67c8a0e92edf49631">share_page</a>(tmp))</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;    <span class="comment">// 取空闲页面，如果内存不够了，则显示内存不够，终止进程。</span></div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;    <span class="keywordflow">if</span> (!(page = <a class="code" href="flash_2Linux-0_811_2mm_2memory_8c.html#af5beb0578c75971eb353cd8a67e9c042">get_free_page</a>()))</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;        <a class="code" href="src_2mm_2memory_8c.html#a8bc8685c6eebde3509bd55c7cf73e6d6">oom</a>();</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;    <span class="comment">// remember that 1 block is used for header</span></div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;    <span class="comment">// 记住，（程序）头要使用1 个数据块</span></div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;    <span class="comment">// 首先计算缺页所在的数据块项。BLOCK_SIZE = 1024 字节，因此一页内存需要4 个数据块。</span></div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    block = 1 + tmp / <a class="code" href="flash_2Linux-0_811_2include_2linux_2fs_8h.html#ad51ded0bbd705f02f73fc60c0b721ced">BLOCK_SIZE</a>;</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;    <span class="comment">// 根据i 节点信息，取数据块在设备上的对应的逻辑块号。</span></div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;    <span class="keywordflow">for</span> (i = 0; i &lt; 4; block++, i++)</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;        nr[i] = <a class="code" href="flash_2Linux-0_811_2fs_2inode_8c.html#a608309a4a886522767be4646f5c709cc">bmap</a>(<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#ae07dc9ad85faa82c21f0280346eee331">executable</a>, block);</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;    <span class="comment">// 读设备上一个页面的数据（4 个逻辑块）到指定物理地址 page 处。</span></div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;    <a class="code" href="flash_2Linux-0_811_2fs_2buffer_8c.html#a7bcdedc1f5ba7597461c3a49559e5b12">bread_page</a>(page, <a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#ae07dc9ad85faa82c21f0280346eee331">executable</a>-&gt;<a class="code" href="structm__inode.html#ab7137e3d8956c00cc96dbbb641d5f7b0">i_dev</a>, nr);</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;    <span class="comment">// 在增加了一页内存后，该页内存的部分可能会超过进程的 end_data 位置。下面的循环即是对物理</span></div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;    <span class="comment">// 页面超出的部分进行清零处理。</span></div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;    i = tmp + 4096 - <a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#ad2bc0934c9dd26a01b156d2a156d7e1b">end_data</a>;</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;    tmp = page + 4096;</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;    <span class="keywordflow">while</span> (i-- &gt; 0) {</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;        tmp--;</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;        *(<span class="keywordtype">char</span> *) tmp = 0;</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;    }</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;    <span class="comment">// 如果把物理页面映射到指定线性地址的操作成功，就返回。否则就释放内存页，显示内存不够。</span></div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="flash_2Linux-0_811_2mm_2memory_8c.html#ace386d1a75522ad316766aa6e3e9432e">put_page</a>(page, address))</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;    <a class="code" href="flash_2Linux-0_811_2mm_2memory_8c.html#a6b87a284a258fa3893dc88c0fcd6f610">free_page</a>(page);</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;    <a class="code" href="src_2mm_2memory_8c.html#a8bc8685c6eebde3509bd55c7cf73e6d6">oom</a>();</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;}</div>
<div class="ttc" id="aflash_2Linux-0_811_2fs_2buffer_8c_html_a7bcdedc1f5ba7597461c3a49559e5b12"><div class="ttname"><a href="flash_2Linux-0_811_2fs_2buffer_8c.html#a7bcdedc1f5ba7597461c3a49559e5b12">bread_page</a></div><div class="ttdeci">void bread_page(unsigned long address, int dev, int b[4])</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2fs_2buffer_8c_source.html#l00292">buffer.c:292</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2fs_2inode_8c_html_a608309a4a886522767be4646f5c709cc"><div class="ttname"><a href="flash_2Linux-0_811_2fs_2inode_8c.html#a608309a4a886522767be4646f5c709cc">bmap</a></div><div class="ttdeci">int bmap(struct m_inode *inode, int block)</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2fs_2inode_8c_source.html#l00140">inode.c:140</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2linux_2fs_8h_html_ad51ded0bbd705f02f73fc60c0b721ced"><div class="ttname"><a href="flash_2Linux-0_811_2include_2linux_2fs_8h.html#ad51ded0bbd705f02f73fc60c0b721ced">BLOCK_SIZE</a></div><div class="ttdeci">#define BLOCK_SIZE</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2fs_8h_source.html#l00049">fs.h:49</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2mm_2memory_8c_html_a20080cae3ade9c434c67fedceeed05d5"><div class="ttname"><a href="flash_2Linux-0_811_2mm_2memory_8c.html#a20080cae3ade9c434c67fedceeed05d5">get_empty_page</a></div><div class="ttdeci">void get_empty_page(unsigned long address)</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2mm_2memory_8c_source.html#l00274">memory.c:274</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2mm_2memory_8c_html_a6b87a284a258fa3893dc88c0fcd6f610"><div class="ttname"><a href="flash_2Linux-0_811_2mm_2memory_8c.html#a6b87a284a258fa3893dc88c0fcd6f610">free_page</a></div><div class="ttdeci">void free_page(unsigned long addr)</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2mm_2memory_8c_source.html#l00089">memory.c:89</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2mm_2memory_8c_html_ace386d1a75522ad316766aa6e3e9432e"><div class="ttname"><a href="flash_2Linux-0_811_2mm_2memory_8c.html#ace386d1a75522ad316766aa6e3e9432e">put_page</a></div><div class="ttdeci">unsigned long put_page(unsigned long page, unsigned long address)</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2mm_2memory_8c_source.html#l00197">memory.c:197</a></div></div>
<div class="ttc" id="asrc_2mm_2memory_8c_html_a8bc8685c6eebde3509bd55c7cf73e6d6"><div class="ttname"><a href="src_2mm_2memory_8c.html#a8bc8685c6eebde3509bd55c7cf73e6d6">oom</a></div><div class="ttdeci">static volatile void oom(void)</div><div class="ttdef"><b>Definition:</b> <a href="src_2mm_2memory_8c_source.html#l00037">memory.c:37</a></div></div>
<div class="ttc" id="asrc_2mm_2memory_8c_html_af17736024759f2f67c8a0e92edf49631"><div class="ttname"><a href="src_2mm_2memory_8c.html#af17736024759f2f67c8a0e92edf49631">share_page</a></div><div class="ttdeci">static int share_page(unsigned long address)</div><div class="ttdef"><b>Definition:</b> <a href="src_2mm_2memory_8c_source.html#l00495">memory.c:495</a></div></div>
<div class="ttc" id="astructm__inode_html_ab7137e3d8956c00cc96dbbb641d5f7b0"><div class="ttname"><a href="structm__inode.html#ab7137e3d8956c00cc96dbbb641d5f7b0">m_inode::i_dev</a></div><div class="ttdeci">unsigned short i_dev</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2fs_8h_source.html#l00105">fs.h:105</a></div></div>
<div class="ttc" id="astructtask__struct_html_ad2bc0934c9dd26a01b156d2a156d7e1b"><div class="ttname"><a href="structtask__struct.html#ad2bc0934c9dd26a01b156d2a156d7e1b">task_struct::end_data</a></div><div class="ttdeci">unsigned long end_data</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2sched_8h_source.html#l00090">sched.h:90</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="src_2mm_2memory_8c_a55531a8e8bf5db98f751b376994ded87_cgraph.png" border="0" usemap="#asrc_2mm_2memory_8c_a55531a8e8bf5db98f751b376994ded87_cgraph" alt=""/></div>
<map name="asrc_2mm_2memory_8c_a55531a8e8bf5db98f751b376994ded87_cgraph" id="asrc_2mm_2memory_8c_a55531a8e8bf5db98f751b376994ded87_cgraph">
<area shape="rect" title=" " alt="" coords="5,929,105,956"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2inode_8c.html#a608309a4a886522767be4646f5c709cc" title=" " alt="" coords="189,803,248,829"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2buffer_8c.html#a7bcdedc1f5ba7597461c3a49559e5b12" title=" " alt="" coords="491,93,589,120"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#a6b87a284a258fa3893dc88c0fcd6f610" title=" " alt="" coords="340,904,427,931"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#a20080cae3ade9c434c67fedceeed05d5" title=" " alt="" coords="153,955,284,981"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#af5beb0578c75971eb353cd8a67e9c042" title=" " alt="" coords="483,1107,597,1133"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#ace386d1a75522ad316766aa6e3e9432e" title=" " alt="" coords="342,1056,425,1083"/>
<area shape="rect" href="src_2mm_2memory_8c.html#a8bc8685c6eebde3509bd55c7cf73e6d6" title=" " alt="" coords="515,1056,565,1083"/>
<area shape="rect" href="src_2mm_2memory_8c.html#af17736024759f2f67c8a0e92edf49631" title=" " alt="" coords="170,1157,267,1184"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2inode_8c.html#ad19b3562cfd0ced5718591d63d158b26" title=" " alt="" coords="350,803,417,829"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2buffer_8c.html#ad78fac6715f3c28e0cf0522df36a111f" title=" " alt="" coords="511,600,569,627"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2buffer_8c.html#ad15c8296a5599c15736bb9383050eec7" title=" " alt="" coords="1346,752,1409,779"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#ab43c5eded9a063f60e583332eaa73258" title=" " alt="" coords="1789,803,1846,829"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2bitmap_8c.html#a3f051047ee70eb8464844e3ab6b430af" title=" " alt="" coords="495,803,585,829"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2buffer_8c.html#a96f49dc697e8292e946ba7680ebecf96" title=" " alt="" coords="1483,347,1601,373"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2buffer_8c.html#a197cebc7bc8d67773a979e92c14b40c0" title=" " alt="" coords="649,423,712,449"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2fs_8h.html#af9add4ad497e3b9eae67e2cbf7cea45e" title=" " alt="" coords="961,144,1056,171"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#add6d90b147b8d600062919f0220600f4" title=" " alt="" coords="1650,600,1729,627"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#a929c48d2c61fe71be34a9cdf0ab04fcc" title=" " alt="" coords="1916,777,1976,804"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2panic_8c.html#acc81aedafa96378bafb37b5bccbccb20" title=" " alt="" coords="1905,828,1987,855"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2printk_8c.html#aaa83f2a89dae6d03dfe15deae29f383a" title=" " alt="" coords="2035,777,2107,804"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#ac2f4c669c6f6aa6caa5ab8adb1b07dd0" title=" " alt="" coords="2159,727,2231,753"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#a3fa7c8ef8597579301cb4b5c59bc6d9a" title=" " alt="" coords="2155,777,2236,804"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2string_8h.html#a2dee044e4e667b5b789b493abd21cfa4" title=" " alt="" coords="2166,828,2225,855"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a8ee0eea1a206d256d223fd33292ddb5d" title=" " alt="" coords="1649,423,1729,449"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2sched_8c.html#ac48128e72b303ea22d8ec641a9516b15" title=" " alt="" coords="1777,423,1857,449"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2buffer_8c.html#a6dd8a689596cf17cdaf4dd6eb6c98e8f" title=" " alt="" coords="963,448,1054,475"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2buffer_8c.html#a26c3be9640a543377e6c6f8d189c83e9" title=" " alt="" coords="776,397,897,424"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2buffer_8c.html#aca6ca6f3081c02518e27afc1d833796a" title=" " alt="" coords="764,296,909,323"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2buffer_8c.html#a3cc00a803282300ea51f20842322814e" title=" " alt="" coords="1108,701,1272,728"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2buffer_8c.html#a95df8a2e491bf4181e3d7b6ddfc755a3" title=" " alt="" coords="795,347,878,373"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2inode_8c.html#a4e8b4c0a66f6ea10acdb053c4f4e8c79" title=" " alt="" coords="957,397,1060,424"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2blk__drv_2ll__rw__blk_8c.html#ae0d0119949a9c5eed9b1128db4f13674" title=" " alt="" coords="1320,93,1435,120"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2blk__drv_2ll__rw__blk_8c.html#a5b8b5c7e1bfc934cbb8b0b8be2a4acd0" title=" " alt="" coords="1491,93,1593,120"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2blk__drv_2ll__rw__blk_8c.html#a304a48e632da3fd0006aa586f7cc7ca7" title=" " alt="" coords="1495,195,1589,221"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2blk__drv_2ll__rw__blk_8c.html#aee00866ea6c51121a5cabe13ca77c191" title=" " alt="" coords="1487,296,1597,323"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2inode_8c.html#aef87a93dd139de38ca5b9baac78f4ccc" title=" " alt="" coords="1132,397,1248,424"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2inode_8c.html#a35a7c0ed9f4a491c42318c15ecefd197" title=" " alt="" coords="1141,600,1239,627"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2super_8c.html#a43f836df13a239d2197028d56018edba" title=" " alt="" coords="1334,499,1421,525"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2inode_8c.html#afa4df3c26552f5d09c7a0d6b080baf55" title=" " alt="" coords="1331,549,1423,576"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2inode_8c.html#a349a2c9da0dd73f8e8324143772650d6" title=" " alt="" coords="1323,600,1431,627"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2super_8c.html#a443c3c886626b03f1130aa6a8758f8ef" title=" " alt="" coords="1484,499,1600,525"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#a8bc8685c6eebde3509bd55c7cf73e6d6" title=" " alt="" coords="515,1005,565,1032"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#ad6b4534f17cfa3172ef7d563e8fda5f2" title=" " alt="" coords="645,1056,716,1083"/>
<area shape="rect" href="src_2mm_2memory_8c.html#a03e623dabb773a2c0ae889137428ff8a" title=" " alt="" coords="332,1157,435,1184"/>
</map>
</div>

</div>
</div>
<a id="ae513bb80700817ae7751c77ab24121f1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae513bb80700817ae7751c77ab24121f1">&#9670;&nbsp;</a></span>do_wp_page()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void do_wp_page </td>
          <td>(</td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>error_code</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>address</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="src_2mm_2memory_8c_source.html#l00352">352</a> of file <a class="el" href="src_2mm_2memory_8c_source.html">memory.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;                                                                 {</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;<span class="preprocessor">#if 0</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    <span class="comment">// we cannot do this yet: the estdio library writes to code space</span></div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    <span class="comment">// stupid, stupid. I really want the libc.a from GNU</span></div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    <span class="comment">// 我们现在还不能这样做：因为estdio 库会在代码空间执行写操作</span></div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    <span class="comment">// 真是太愚蠢了。我真想从GNU 得到libc.a 库.</span></div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;    <span class="keywordflow">if</span>(<a class="code" href="src_2mm_2memory_8c.html#a7c9b7ceb44098d55b2c89b895c8dd096">CODE_SPACE</a> (address))    <span class="comment">// 如果地址位于代码空间，则终止执行程序。</span></div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;      <a class="code" href="flash_2Linux-0_811_2mm_2memory_8c.html#ad6b4534f17cfa3172ef7d563e8fda5f2">do_exit</a> (<a class="code" href="flash_2Linux-0_811_2include_2signal_8h.html#ae20b4f7171a09516ea73c9d2745bd596">SIGSEGV</a>);</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;    <span class="comment">// 处理取消页面保护。参数指定页面在页表中的页表项指针，其计算方法是：</span></div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;    <span class="comment">// ((address&gt;&gt;10) &amp; 0xffc)：计算指定地址的页面在页表中的偏移地址；</span></div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;    <span class="comment">// (0xfffff000 &amp;((address&gt;&gt;20) &amp;0xffc))：取目录项中页表的地址值，</span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;    <span class="comment">// 其中((address&gt;&gt;20) &amp;0xffc)计算页面所在页表的目录项指针；</span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    <span class="comment">// 两者相加即得指定地址对应页面的页表项指针。这里对共享的页面进行复制。</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;    <a class="code" href="flash_2Linux-0_811_2mm_2memory_8c.html#a7beb786b07c313c61111c5709391f3d3">un_wp_page</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;                       (((address &gt;&gt; 10) &amp; 0xffc) + (0xfffff000 &amp; *((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *)</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;                               ((address &gt;&gt; 20) &amp; 0xffc)))));</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;}</div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2signal_8h_html_ae20b4f7171a09516ea73c9d2745bd596"><div class="ttname"><a href="flash_2Linux-0_811_2include_2signal_8h.html#ae20b4f7171a09516ea73c9d2745bd596">SIGSEGV</a></div><div class="ttdeci">#define SIGSEGV</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2signal_8h_source.html#l00023">signal.h:23</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2mm_2memory_8c_html_a7beb786b07c313c61111c5709391f3d3"><div class="ttname"><a href="flash_2Linux-0_811_2mm_2memory_8c.html#a7beb786b07c313c61111c5709391f3d3">un_wp_page</a></div><div class="ttdeci">void un_wp_page(unsigned long *table_entry)</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2mm_2memory_8c_source.html#l00221">memory.c:221</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2mm_2memory_8c_html_ad6b4534f17cfa3172ef7d563e8fda5f2"><div class="ttname"><a href="flash_2Linux-0_811_2mm_2memory_8c.html#ad6b4534f17cfa3172ef7d563e8fda5f2">do_exit</a></div><div class="ttdeci">volatile void do_exit(long code)</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2kernel_2exit_8c_source.html#l00102">exit.c:102</a></div></div>
<div class="ttc" id="asrc_2mm_2memory_8c_html_a7c9b7ceb44098d55b2c89b895c8dd096"><div class="ttname"><a href="src_2mm_2memory_8c.html#a7c9b7ceb44098d55b2c89b895c8dd096">CODE_SPACE</a></div><div class="ttdeci">#define CODE_SPACE(addr)</div><div class="ttdef"><b>Definition:</b> <a href="src_2mm_2memory_8c_source.html#l00060">memory.c:60</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="src_2mm_2memory_8c_ae513bb80700817ae7751c77ab24121f1_cgraph.png" border="0" usemap="#asrc_2mm_2memory_8c_ae513bb80700817ae7751c77ab24121f1_cgraph" alt=""/></div>
<map name="asrc_2mm_2memory_8c_ae513bb80700817ae7751c77ab24121f1_cgraph" id="asrc_2mm_2memory_8c_ae513bb80700817ae7751c77ab24121f1_cgraph">
<area shape="rect" title=" " alt="" coords="5,5,108,32"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#ad6b4534f17cfa3172ef7d563e8fda5f2" title=" " alt="" coords="469,5,540,32"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#a7beb786b07c313c61111c5709391f3d3" title=" " alt="" coords="156,31,259,57"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#af5beb0578c75971eb353cd8a67e9c042" title=" " alt="" coords="307,31,421,57"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#a8bc8685c6eebde3509bd55c7cf73e6d6" title=" " alt="" coords="339,81,389,108"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#a929c48d2c61fe71be34a9cdf0ab04fcc" title=" " alt="" coords="475,81,535,108"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2printk_8c.html#aaa83f2a89dae6d03dfe15deae29f383a" title=" " alt="" coords="588,81,660,108"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#ac2f4c669c6f6aa6caa5ab8adb1b07dd0" title=" " alt="" coords="713,31,785,57"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#a3fa7c8ef8597579301cb4b5c59bc6d9a" title=" " alt="" coords="708,81,789,108"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2string_8h.html#a2dee044e4e667b5b789b493abd21cfa4" title=" " alt="" coords="719,132,778,159"/>
</map>
</div>

</div>
</div>
<a id="a6b87a284a258fa3893dc88c0fcd6f610"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6b87a284a258fa3893dc88c0fcd6f610">&#9670;&nbsp;</a></span>free_page()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void free_page </td>
          <td>(</td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>addr</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="src_2mm_2memory_8c_source.html#l00115">115</a> of file <a class="el" href="src_2mm_2memory_8c_source.html">memory.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;                                   {</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    <span class="keywordflow">if</span> (addr &lt; <a class="code" href="src_2mm_2memory_8c.html#a33546c633e25fbc31ba28c4419b37af4">LOW_MEM</a>)</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;        <span class="keywordflow">return</span>;            <span class="comment">// 如果物理地址 addr 小于内存低端（1MB），则返回。</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    <span class="keywordflow">if</span> (addr &gt;= <a class="code" href="src_2mm_2memory_8c.html#a9838fae7bc8607f03ff29cfd191441c7">HIGH_MEMORY</a>)    <span class="comment">// 如果物理地址 addr&gt;=内存最高端，则显示出错信息。</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;        <a class="code" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#ab43c5eded9a063f60e583332eaa73258">panic</a>(<span class="stringliteral">&quot;trying to free nonexistent page&quot;</span>);</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    addr -= <a class="code" href="src_2mm_2memory_8c.html#a33546c633e25fbc31ba28c4419b37af4">LOW_MEM</a>;        <span class="comment">// 物理地址减去低端内存位置，再除以 4KB，得页面号。</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    addr &gt;&gt;= 12;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="src_2mm_2memory_8c.html#a55d0a3018dfecd08963844523d3d4b64">mem_map</a>[addr]--)</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;        <span class="keywordflow">return</span>;            <span class="comment">// 如果对应内存页面映射字节不等于 0，则减 1 返回。</span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    <a class="code" href="src_2mm_2memory_8c.html#a55d0a3018dfecd08963844523d3d4b64">mem_map</a>[addr] = 0;        <span class="comment">// 否则置对应页面映射字节为 0，并显示出错信息，死机。</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    <a class="code" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#ab43c5eded9a063f60e583332eaa73258">panic</a>(<span class="stringliteral">&quot;trying to free free page&quot;</span>);</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;}</div>
<div class="ttc" id="asrc_2mm_2memory_8c_html_a9838fae7bc8607f03ff29cfd191441c7"><div class="ttname"><a href="src_2mm_2memory_8c.html#a9838fae7bc8607f03ff29cfd191441c7">HIGH_MEMORY</a></div><div class="ttdeci">static long HIGH_MEMORY</div><div class="ttdef"><b>Definition:</b> <a href="src_2mm_2memory_8c_source.html#l00063">memory.c:63</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="src_2mm_2memory_8c_a6b87a284a258fa3893dc88c0fcd6f610_cgraph.png" border="0" usemap="#asrc_2mm_2memory_8c_a6b87a284a258fa3893dc88c0fcd6f610_cgraph" alt=""/></div>
<map name="asrc_2mm_2memory_8c_a6b87a284a258fa3893dc88c0fcd6f610_cgraph" id="asrc_2mm_2memory_8c_a6b87a284a258fa3893dc88c0fcd6f610_cgraph">
<area shape="rect" title=" " alt="" coords="5,81,92,108"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#ab43c5eded9a063f60e583332eaa73258" title=" " alt="" coords="140,81,197,108"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#a929c48d2c61fe71be34a9cdf0ab04fcc" title=" " alt="" coords="256,56,316,83"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2panic_8c.html#acc81aedafa96378bafb37b5bccbccb20" title=" " alt="" coords="245,107,327,133"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2printk_8c.html#aaa83f2a89dae6d03dfe15deae29f383a" title=" " alt="" coords="375,56,447,83"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#ac2f4c669c6f6aa6caa5ab8adb1b07dd0" title=" " alt="" coords="499,5,571,32"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#a3fa7c8ef8597579301cb4b5c59bc6d9a" title=" " alt="" coords="495,56,576,83"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2string_8h.html#a2dee044e4e667b5b789b493abd21cfa4" title=" " alt="" coords="506,107,565,133"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="src_2mm_2memory_8c_a6b87a284a258fa3893dc88c0fcd6f610_icgraph.png" border="0" usemap="#asrc_2mm_2memory_8c_a6b87a284a258fa3893dc88c0fcd6f610_icgraph" alt=""/></div>
<map name="asrc_2mm_2memory_8c_a6b87a284a258fa3893dc88c0fcd6f610_icgraph" id="asrc_2mm_2memory_8c_a6b87a284a258fa3893dc88c0fcd6f610_icgraph">
<area shape="rect" title=" " alt="" coords="1028,157,1115,184"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2fork_8c.html#ab154f2aa621bc4a2a554496a7eaa59ab" title=" " alt="" coords="869,5,980,32"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2exec_8c.html#a91e86d0620f471b2fa1276658f635455" title=" " alt="" coords="143,157,233,184"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#afc592a700b55033301c03b0e665c5269" title=" " alt="" coords="893,791,956,817"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2inode_8c.html#afa76e75f45af948cbb6e5da444038f40" title=" " alt="" coords="901,740,948,767"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2exit_8c.html#a4b358e49189bbfecc559204d6f1e8694" title=" " alt="" coords="889,157,960,184"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2exit_8c.html#a30772d89021c1d79338fbd93ceed5762" title=" " alt="" coords="591,233,661,260"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2namei_8c.html#a13fdfb79df1bf5e5f9b0db0b484e26ed" title=" " alt="" coords="729,1424,815,1451"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2namei_8c.html#a658203e2c0a6d0bf5f672b319e3880dd" title=" " alt="" coords="593,1475,659,1501"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2namei_8c.html#ae192f1ee0225a7a7c86385b7bf653ac2" title=" " alt="" coords="307,664,369,691"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2open_8c.html#a9be063177c32c1c12fedb43fc223f20e" title=" " alt="" coords="141,336,235,363"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2open_8c.html#a837b903fbb61e1e7f5f3b6fe75cddcea" title=" " alt="" coords="147,400,229,427"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2open_8c.html#ab1034e286b88da9661927f127cb51ba7" title=" " alt="" coords="141,464,235,491"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2open_8c.html#a762bca791b54ecba3696f76c6184204d" title=" " alt="" coords="141,516,235,543"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2open_8c.html#aa1b3b6fd527147d503d81563d606f6a1" title=" " alt="" coords="142,569,234,596"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2namei_8c.html#a66e6e29e97a5c76efd95d4cb140f8a24" title=" " alt="" coords="151,1449,225,1476"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2super_8c.html#a02dcfdb731cb4c5dfc6fcd8516dabf98" title=" " alt="" coords="141,627,235,653"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2stat_8c.html#a8d4a37bb6cbbf7fe6db13504f67d9234" title=" " alt="" coords="150,689,226,716"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2super_8c.html#a6f09e1a09832c2a7f44ea07d32fd426e" title=" " alt="" coords="137,740,239,767"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2open_8c.html#a501239313f8fa813f492bedfa92538a7" title=" " alt="" coords="143,816,233,843"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2namei_8c.html#ad08df58f033bd23ea1315499d697a3b0" title=" " alt="" coords="287,1309,389,1336"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2open_8c.html#a710bd8fc9f99d575d34e7fb7e64c8c09" title=" " alt="" coords="147,1019,229,1045"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2namei_8c.html#a484b43eaa2a0c71c933dca84174f496f" title=" " alt="" coords="293,1652,383,1679"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2namei_8c.html#a329edacaaf13eaf9a95b006a7675d84e" title=" " alt="" coords="290,1716,386,1743"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2namei_8c.html#a27d1ae044824cfad6f765292986d316a" title=" " alt="" coords="295,1525,381,1552"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2namei_8c.html#aefea47c20c5dfe12a0815af38f767b4f" title=" " alt="" coords="293,1132,383,1159"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2inode_8c.html#a78b297f206aacdb913d2db4db1ef6689" title=" " alt="" coords="749,1120,795,1147"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2bitmap_8c.html#aa17030f2c3706317c68a4552b2d8f61e" title=" " alt="" coords="437,1677,529,1704"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2open_8c.html#a186ae5192f6afb2ec4fcd93cb592031d" title=" " alt="" coords="729,411,815,437"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2exec_8c.html#ae8584b188355851cdd6f403cd5df3c12" title=" " alt="" coords="445,233,521,260"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2namei_8c.html#ae932b00aa69ebad7e231776a4da1fb01" title=" " alt="" coords="440,1475,527,1501"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2open_8c.html#a97da1b73b641350471360707e39ed5f6" title=" " alt="" coords="5,1019,89,1045"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2super_8c.html#a516f58ff075ed9e15bb77645c5d55b56" title=" " alt="" coords="577,1221,675,1248"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2blk__drv_2hd_8c.html#a1e990fd03a090a3504d84824343bc54a" title=" " alt="" coords="440,1221,527,1248"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2exit_8c.html#a69163056b363c343e0467605762db26c" title=" " alt="" coords="723,107,821,133"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2exit_8c.html#a8ca56e7d5016dbf7a39ef89eeda70be6" title=" " alt="" coords="727,208,817,235"/>
</map>
</div>

</div>
</div>
<a id="a235add1ba6e02ce735d70348d51b25da"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a235add1ba6e02ce735d70348d51b25da">&#9670;&nbsp;</a></span>free_page_tables()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int free_page_tables </td>
          <td>(</td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>from</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="src_2mm_2memory_8c_source.html#l00140">140</a> of file <a class="el" href="src_2mm_2memory_8c_source.html">memory.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;                                                             {</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *pg_table;</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *dir, nr;</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160; </div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    <span class="keywordflow">if</span> (from &amp; 0x3fffff)        <span class="comment">// 要释放内存块的地址需以4M 为边界。</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        <a class="code" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#ab43c5eded9a063f60e583332eaa73258">panic</a>(<span class="stringliteral">&quot;free_page_tables called with wrong alignment&quot;</span>);</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    <span class="keywordflow">if</span> (!from)            <span class="comment">// 出错，试图释放内核和缓冲所占空间。</span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        <a class="code" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#ab43c5eded9a063f60e583332eaa73258">panic</a>(<span class="stringliteral">&quot;Trying to free up swapper memory space&quot;</span>);</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    <span class="comment">// 计算所占页目录项数(4M 的进位整数倍)，也即所占页表数。</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    size = (size + 0x3fffff) &gt;&gt; 22;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    <span class="comment">// 下面一句计算起始目录项。对应的目录项号=from&gt;&gt;22，因每项占 4 字节，并且由于页目录是从</span></div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    <span class="comment">// 物理地址 0 开始，因此实际的目录项指针=目录项号&lt;&lt;2，也即(from&gt;&gt;20)。与上 0xffc 确保</span></div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    <span class="comment">// 目录项指针范围有效。</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    dir = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *) ((from &gt;&gt; 20) &amp; 0xffc);     <span class="comment">// _pg_dir = 0</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    <span class="keywordflow">for</span> (; size-- &gt; 0; dir++) {                <span class="comment">// size 现在是需要被释放内存的目录项数。</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        <span class="keywordflow">if</span> (!(1 &amp; *dir))        <span class="comment">// 如果该目录项无效(P 位=0)，则继续。</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;            <span class="keywordflow">continue</span>;        <span class="comment">// 目录项的位0(P 位)表示对应页表是否存在。</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;        pg_table = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *) (0xfffff000 &amp; *dir);    <span class="comment">// 取目录项中页表地址。</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        <span class="keywordflow">for</span> (nr = 0; nr &lt; 1024; nr++) {            <span class="comment">// 每个页表有1024 个页项。</span></div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;            <span class="keywordflow">if</span> (1 &amp; *pg_table)    <span class="comment">// 若该页表项有效(P 位=1)，则释放对应内存页。</span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;                <a class="code" href="flash_2Linux-0_811_2mm_2memory_8c.html#a6b87a284a258fa3893dc88c0fcd6f610">free_page</a>(0xfffff000 &amp; *pg_table);</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;            *pg_table = 0;    <span class="comment">// 该页表项内容清零。</span></div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;            pg_table++;        <span class="comment">// 指向页表中下一项。</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        }</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        <a class="code" href="flash_2Linux-0_811_2mm_2memory_8c.html#a6b87a284a258fa3893dc88c0fcd6f610">free_page</a>(0xfffff000 &amp; *dir);    <span class="comment">// 释放该页表所占内存页面。但由于页表在物理地址 1M 以内，</span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;        <span class="comment">// 所以这句什么都不做。</span></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;        *dir = 0;            <span class="comment">// 对相应页表的目录项清零。</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    }</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    <a class="code" href="src_2mm_2memory_8c.html#acf7d1d4e3ad496402dd3b5fbe365105d">invalidate</a>();        <span class="comment">// 刷新页变换高速缓冲。</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="src_2mm_2memory_8c_a235add1ba6e02ce735d70348d51b25da_cgraph.png" border="0" usemap="#asrc_2mm_2memory_8c_a235add1ba6e02ce735d70348d51b25da_cgraph" alt=""/></div>
<map name="asrc_2mm_2memory_8c_a235add1ba6e02ce735d70348d51b25da_cgraph" id="asrc_2mm_2memory_8c_a235add1ba6e02ce735d70348d51b25da_cgraph">
<area shape="rect" title=" " alt="" coords="5,56,140,83"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#a6b87a284a258fa3893dc88c0fcd6f610" title=" " alt="" coords="188,31,275,57"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#ab43c5eded9a063f60e583332eaa73258" title=" " alt="" coords="203,81,260,108"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#a929c48d2c61fe71be34a9cdf0ab04fcc" title=" " alt="" coords="333,56,393,83"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2panic_8c.html#acc81aedafa96378bafb37b5bccbccb20" title=" " alt="" coords="323,107,404,133"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2printk_8c.html#aaa83f2a89dae6d03dfe15deae29f383a" title=" " alt="" coords="452,56,524,83"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#ac2f4c669c6f6aa6caa5ab8adb1b07dd0" title=" " alt="" coords="577,5,649,32"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#a3fa7c8ef8597579301cb4b5c59bc6d9a" title=" " alt="" coords="572,56,653,83"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2string_8h.html#a2dee044e4e667b5b789b493abd21cfa4" title=" " alt="" coords="583,107,642,133"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="src_2mm_2memory_8c_a235add1ba6e02ce735d70348d51b25da_icgraph.png" border="0" usemap="#asrc_2mm_2memory_8c_a235add1ba6e02ce735d70348d51b25da_icgraph" alt=""/></div>
<map name="asrc_2mm_2memory_8c_a235add1ba6e02ce735d70348d51b25da_icgraph" id="asrc_2mm_2memory_8c_a235add1ba6e02ce735d70348d51b25da_icgraph">
<area shape="rect" title=" " alt="" coords="307,56,441,83"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2fork_8c.html#a83662a2300404942511d99c80128deb1" title=" " alt="" coords="164,5,259,32"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2exec_8c.html#a91e86d0620f471b2fa1276658f635455" title=" " alt="" coords="166,56,257,83"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2exit_8c.html#a30772d89021c1d79338fbd93ceed5762" title=" " alt="" coords="176,107,247,133"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2fork_8c.html#ab154f2aa621bc4a2a554496a7eaa59ab" title=" " alt="" coords="5,5,116,32"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2exec_8c.html#ae8584b188355851cdd6f403cd5df3c12" title=" " alt="" coords="23,107,99,133"/>
</map>
</div>

</div>
</div>
<a id="a20080cae3ade9c434c67fedceeed05d5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a20080cae3ade9c434c67fedceeed05d5">&#9670;&nbsp;</a></span>get_empty_page()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void get_empty_page </td>
          <td>(</td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>address</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="src_2mm_2memory_8c_source.html#l00391">391</a> of file <a class="el" href="src_2mm_2memory_8c_source.html">memory.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;                                           {</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> tmp;</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160; </div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    <span class="comment">// 若不能取得一空闲页面，或者不能将页面放置到指定地址处，则显示内存不够的信息。</span></div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;    <span class="comment">// 22222 行上英文注释的含义是：即使执行 get_free_page() 返回 0 也无所谓，因为 put_page()</span></div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;    <span class="comment">// 中还会对此情况再次申请空闲物理页面的，见 222222 行。</span></div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    <span class="keywordflow">if</span> (!(tmp = <a class="code" href="flash_2Linux-0_811_2mm_2memory_8c.html#af5beb0578c75971eb353cd8a67e9c042">get_free_page</a>()) || !<a class="code" href="flash_2Linux-0_811_2mm_2memory_8c.html#ace386d1a75522ad316766aa6e3e9432e">put_page</a>(tmp, address)) {</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;        <a class="code" href="flash_2Linux-0_811_2mm_2memory_8c.html#a6b87a284a258fa3893dc88c0fcd6f610">free_page</a>(tmp);        <span class="comment">// 0 is ok - ignored</span></div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;        <a class="code" href="src_2mm_2memory_8c.html#a8bc8685c6eebde3509bd55c7cf73e6d6">oom</a>();</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;    }</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="src_2mm_2memory_8c_a20080cae3ade9c434c67fedceeed05d5_cgraph.png" border="0" usemap="#asrc_2mm_2memory_8c_a20080cae3ade9c434c67fedceeed05d5_cgraph" alt=""/></div>
<map name="asrc_2mm_2memory_8c_a20080cae3ade9c434c67fedceeed05d5_cgraph" id="asrc_2mm_2memory_8c_a20080cae3ade9c434c67fedceeed05d5_cgraph">
<area shape="rect" title=" " alt="" coords="5,81,136,108"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#a6b87a284a258fa3893dc88c0fcd6f610" title=" " alt="" coords="198,5,285,32"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#af5beb0578c75971eb353cd8a67e9c042" title=" " alt="" coords="184,56,299,83"/>
<area shape="rect" href="src_2mm_2memory_8c.html#a8bc8685c6eebde3509bd55c7cf73e6d6" title=" " alt="" coords="216,107,267,133"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#ace386d1a75522ad316766aa6e3e9432e" title=" " alt="" coords="200,157,283,184"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#ad6b4534f17cfa3172ef7d563e8fda5f2" title=" " alt="" coords="347,81,417,108"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#a929c48d2c61fe71be34a9cdf0ab04fcc" title=" " alt="" coords="352,132,412,159"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2printk_8c.html#aaa83f2a89dae6d03dfe15deae29f383a" title=" " alt="" coords="465,132,537,159"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#ac2f4c669c6f6aa6caa5ab8adb1b07dd0" title=" " alt="" coords="590,81,662,108"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#a3fa7c8ef8597579301cb4b5c59bc6d9a" title=" " alt="" coords="585,132,667,159"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2string_8h.html#a2dee044e4e667b5b789b493abd21cfa4" title=" " alt="" coords="597,183,655,209"/>
</map>
</div>

</div>
</div>
<a id="af5beb0578c75971eb353cd8a67e9c042"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af5beb0578c75971eb353cd8a67e9c042">&#9670;&nbsp;</a></span>get_free_page()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">unsigned long get_free_page </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="src_2mm_2memory_8c_source.html#l00086">86</a> of file <a class="el" href="src_2mm_2memory_8c_source.html">memory.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;                                  {</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    <span class="keyword">register</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> __res <span class="keyword">asm</span> (<span class="stringliteral">&quot;ax&quot;</span>);</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160; </div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    __asm__ (<span class="stringliteral">&quot;std ; repne ; scasb\n\t&quot;</span>    <span class="comment">// 方向位置位，将 al(0)与对应每个页面的(di)内容比较，</span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;             <span class="stringliteral">&quot;jne 1f\n\t&quot;</span>        <span class="comment">// 如果没有等于 0 的字节，则跳转结束(返回 0).</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;             <span class="stringliteral">&quot;movb $1,1(%%edi)\n\t&quot;</span>    <span class="comment">// 将对应页面的内存映像位置 1。</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;             <span class="stringliteral">&quot;sall $12,%%ecx\n\t&quot;</span>    <span class="comment">// 页面数* 4K = 相对页面起始地址。</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;             <span class="stringliteral">&quot;addl %2,%%ecx\n\t&quot;</span>    <span class="comment">// 再加上低端内存地址，即获得页面实际物理起始地址。</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;             <span class="stringliteral">&quot;movl %%ecx,%%edx\n\t&quot;</span>    <span class="comment">// 将页面实际起始地址 -&gt; edx 寄存器。</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;             <span class="stringliteral">&quot;movl $1024,%%ecx\n\t&quot;</span>    <span class="comment">// 寄存器 ecx 置计数值 1024。</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;             <span class="stringliteral">&quot;leal 4092(%%edx),%%edi\n\t&quot;</span>    <span class="comment">// 将 4092+edx 的位置-&gt; edi(该页面的末端)。</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;             <span class="stringliteral">&quot;rep ; stosl\n\t&quot;</span>    <span class="comment">// 将 edi 所指内存清零（反方向，也即将该页面清零）。</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;             <span class="stringliteral">&quot;movl %%edx,%%eax\n&quot;</span>    <span class="comment">// 将页面起始地址-&gt;eax（返回值）。</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;             <span class="stringliteral">&quot;1:&quot;</span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;            :<span class="stringliteral">&quot;=a&quot;</span> (__res)</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;            :<span class="stringliteral">&quot;&quot;</span> (0), <span class="stringliteral">&quot;i&quot;</span>(<a class="code" href="src_2mm_2memory_8c.html#a33546c633e25fbc31ba28c4419b37af4">LOW_MEM</a>), <span class="stringliteral">&quot;c&quot;</span> (<a class="code" href="src_2mm_2memory_8c.html#a1843924b1500f8e01c5fc255b02088d2">PAGING_PAGES</a>),</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    <span class="stringliteral">&quot;D&quot;</span> (<a class="code" href="src_2mm_2memory_8c.html#a55d0a3018dfecd08963844523d3d4b64">mem_map</a> + <a class="code" href="src_2mm_2memory_8c.html#a1843924b1500f8e01c5fc255b02088d2">PAGING_PAGES</a> - 1)</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;            );</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    <span class="keywordflow">return</span> __res;            <span class="comment">// 返回空闲页面地址（如果无空闲也则返回0）。</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="src_2mm_2memory_8c_af5beb0578c75971eb353cd8a67e9c042_icgraph.png" border="0" usemap="#asrc_2mm_2memory_8c_af5beb0578c75971eb353cd8a67e9c042_icgraph" alt=""/></div>
<map name="asrc_2mm_2memory_8c_af5beb0578c75971eb353cd8a67e9c042_icgraph" id="asrc_2mm_2memory_8c_af5beb0578c75971eb353cd8a67e9c042_icgraph">
<area shape="rect" title=" " alt="" coords="323,107,437,133"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2fork_8c.html#ab154f2aa621bc4a2a554496a7eaa59ab" title=" " alt="" coords="154,5,265,32"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2exec_8c.html#a6efbdf7b5b50e6a4a869053c2d19f921" title=" " alt="" coords="157,56,261,83"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2inode_8c.html#a29c1dadaac141814cea5e34ce43d5c32" title=" " alt="" coords="149,107,270,133"/>
<area shape="rect" href="flash_2Linux-0_811_2lib_2malloc_8c.html#a71280d46775a69fb38ebadf19c2a26ea" title=" " alt="" coords="144,157,275,184"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#ac0a811fd8b7a378500f100a2d9a1f1a2" title=" " alt="" coords="17,183,84,209"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2exec_8c.html#a91e86d0620f471b2fa1276658f635455" title=" " alt="" coords="5,56,96,83"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2pipe_8c.html#a1e5ec5c4745591e77d7df87b314cc1a9" title=" " alt="" coords="11,107,90,133"/>
</map>
</div>

</div>
</div>
<a id="a570fcb455a6b0459ada06e7825b783f2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a570fcb455a6b0459ada06e7825b783f2">&#9670;&nbsp;</a></span>mem_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void mem_init </td>
          <td>(</td>
          <td class="paramtype">long&#160;</td>
          <td class="paramname"><em>start_mem</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">long&#160;</td>
          <td class="paramname"><em>end_mem</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="src_2mm_2memory_8c_source.html#l00574">574</a> of file <a class="el" href="src_2mm_2memory_8c_source.html">memory.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;                                            {</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;    <span class="keywordtype">int</span> i;</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160; </div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;    <a class="code" href="src_2mm_2memory_8c.html#a9838fae7bc8607f03ff29cfd191441c7">HIGH_MEMORY</a> = end_mem;    <span class="comment">// 设置内存最高端。</span></div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="src_2mm_2memory_8c.html#a1843924b1500f8e01c5fc255b02088d2">PAGING_PAGES</a>; i++)    <span class="comment">// 首先置所有页面为已占用(USED=100)状态，</span></div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;        <a class="code" href="src_2mm_2memory_8c.html#a55d0a3018dfecd08963844523d3d4b64">mem_map</a>[i] = <a class="code" href="src_2mm_2memory_8c.html#abcd0a22ee4346cad5706adb6d2119429">USED</a>;        <span class="comment">// 即将页面映射数组全置成 USED。</span></div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;    i = <a class="code" href="src_2mm_2memory_8c.html#a5a6ea6599d09c9ce1d393125c30965ca">MAP_NR</a>(start_mem);    <span class="comment">// 然后计算可使用起始内存的页面号。</span></div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;    end_mem -= start_mem;        <span class="comment">// 再计算可分页处理的内存块大小。</span></div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;    end_mem &gt;&gt;= 12;        <span class="comment">// 从而计算出可用于分页处理的页面数。</span></div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;    <span class="keywordflow">while</span> (end_mem-- &gt; 0)        <span class="comment">// 最后将这些可用页面对应的页面映射数组清零。</span></div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;        <a class="code" href="src_2mm_2memory_8c.html#a55d0a3018dfecd08963844523d3d4b64">mem_map</a>[i++] = 0;</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;}</div>
<div class="ttc" id="asrc_2mm_2memory_8c_html_a5a6ea6599d09c9ce1d393125c30965ca"><div class="ttname"><a href="src_2mm_2memory_8c.html#a5a6ea6599d09c9ce1d393125c30965ca">MAP_NR</a></div><div class="ttdeci">#define MAP_NR(addr)</div><div class="ttdef"><b>Definition:</b> <a href="src_2mm_2memory_8c_source.html#l00055">memory.c:55</a></div></div>
<div class="ttc" id="asrc_2mm_2memory_8c_html_abcd0a22ee4346cad5706adb6d2119429"><div class="ttname"><a href="src_2mm_2memory_8c.html#abcd0a22ee4346cad5706adb6d2119429">USED</a></div><div class="ttdeci">#define USED</div><div class="ttdef"><b>Definition:</b> <a href="src_2mm_2memory_8c_source.html#l00056">memory.c:56</a></div></div>
</div><!-- fragment -->
</div>
</div>
<a id="a8bc8685c6eebde3509bd55c7cf73e6d6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8bc8685c6eebde3509bd55c7cf73e6d6">&#9670;&nbsp;</a></span>oom()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static volatile void oom </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="src_2mm_2memory_8c_source.html#l00037">37</a> of file <a class="el" href="src_2mm_2memory_8c_source.html">memory.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;                                      {</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;    <a class="code" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#a929c48d2c61fe71be34a9cdf0ab04fcc">printk</a>(<span class="stringliteral">&quot;out of memory\n\r&quot;</span>);</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;    <a class="code" href="flash_2Linux-0_811_2mm_2memory_8c.html#ad6b4534f17cfa3172ef7d563e8fda5f2">do_exit</a>(<a class="code" href="flash_2Linux-0_811_2include_2signal_8h.html#ae20b4f7171a09516ea73c9d2745bd596">SIGSEGV</a>);        <span class="comment">// do_exit() 应该使用退出代码，这里用了信号值 SIGSEGV(11)</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;}                <span class="comment">// 相同值的出错码含义是“资源暂时不可用”，正好同义。</span></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="src_2mm_2memory_8c_a8bc8685c6eebde3509bd55c7cf73e6d6_cgraph.png" border="0" usemap="#asrc_2mm_2memory_8c_a8bc8685c6eebde3509bd55c7cf73e6d6_cgraph" alt=""/></div>
<map name="asrc_2mm_2memory_8c_a8bc8685c6eebde3509bd55c7cf73e6d6_cgraph" id="asrc_2mm_2memory_8c_a8bc8685c6eebde3509bd55c7cf73e6d6_cgraph">
<area shape="rect" title=" " alt="" coords="5,31,56,57"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#ad6b4534f17cfa3172ef7d563e8fda5f2" title=" " alt="" coords="104,5,175,32"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#a929c48d2c61fe71be34a9cdf0ab04fcc" title=" " alt="" coords="109,56,169,83"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2printk_8c.html#aaa83f2a89dae6d03dfe15deae29f383a" title=" " alt="" coords="223,56,295,83"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#ac2f4c669c6f6aa6caa5ab8adb1b07dd0" title=" " alt="" coords="347,5,419,32"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#a3fa7c8ef8597579301cb4b5c59bc6d9a" title=" " alt="" coords="343,56,424,83"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2string_8h.html#a2dee044e4e667b5b789b493abd21cfa4" title=" " alt="" coords="354,107,413,133"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="src_2mm_2memory_8c_a8bc8685c6eebde3509bd55c7cf73e6d6_icgraph.png" border="0" usemap="#asrc_2mm_2memory_8c_a8bc8685c6eebde3509bd55c7cf73e6d6_icgraph" alt=""/></div>
<map name="asrc_2mm_2memory_8c_a8bc8685c6eebde3509bd55c7cf73e6d6_icgraph" id="asrc_2mm_2memory_8c_a8bc8685c6eebde3509bd55c7cf73e6d6_icgraph">
<area shape="rect" title=" " alt="" coords="477,61,528,87"/>
<area shape="rect" href="src_2mm_2memory_8c.html#a55531a8e8bf5db98f751b376994ded87" title=" " alt="" coords="5,35,105,62"/>
<area shape="rect" href="src_2mm_2memory_8c.html#a20080cae3ade9c434c67fedceeed05d5" title=" " alt="" coords="299,35,429,62"/>
<area shape="rect" href="src_2mm_2memory_8c.html#a03e623dabb773a2c0ae889137428ff8a" title=" " alt="" coords="313,86,415,113"/>
<area shape="rect" href="src_2mm_2memory_8c.html#a7beb786b07c313c61111c5709391f3d3" title=" " alt="" coords="313,137,415,163"/>
<area shape="rect" href="src_2mm_2memory_8c.html#af17736024759f2f67c8a0e92edf49631" title=" " alt="" coords="153,61,251,87"/>
</map>
</div>

</div>
</div>
<a id="ace386d1a75522ad316766aa6e3e9432e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ace386d1a75522ad316766aa6e3e9432e">&#9670;&nbsp;</a></span>put_page()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">unsigned long put_page </td>
          <td>(</td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>page</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>address</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="src_2mm_2memory_8c_source.html#l00277">277</a> of file <a class="el" href="src_2mm_2memory_8c_source.html">memory.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;                                                                  {</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> tmp, *page_table;</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160; </div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    <span class="comment">// NOTE !!! This uses the fact that _pg_dir=0</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    <span class="comment">// 注意!!! 这里使用了页目录基址 _pg_dir=0 的条件</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160; </div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    <span class="comment">// 如果申请的页面位置低于 LOW_MEM(1Mb) 或超出系统实际含有内存高端 HIGH_MEMORY，则发出警告。</span></div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    <span class="keywordflow">if</span> (page &lt; LOW_MEM || page &gt;= <a class="code" href="src_2mm_2memory_8c.html#a9838fae7bc8607f03ff29cfd191441c7">HIGH_MEMORY</a>)</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;        <a class="code" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#a929c48d2c61fe71be34a9cdf0ab04fcc">printk</a>(<span class="stringliteral">&quot;Trying to put page %p at %p\n&quot;</span>, page, address);</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    <span class="comment">// 如果申请的页面在内存页面映射字节图中没有置位，则显示警告信息。</span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="src_2mm_2memory_8c.html#a55d0a3018dfecd08963844523d3d4b64">mem_map</a>[(page - <a class="code" href="src_2mm_2memory_8c.html#a33546c633e25fbc31ba28c4419b37af4">LOW_MEM</a>) &gt;&gt; 12] != 1)</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;        <a class="code" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#a929c48d2c61fe71be34a9cdf0ab04fcc">printk</a>(<span class="stringliteral">&quot;mem_map disagrees with %p at %p\n&quot;</span>, page, address);</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;    <span class="comment">// 计算指定地址在页目录表中对应的目录项指针。</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;    page_table = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *) ((address &gt;&gt; 20) &amp; 0xffc);</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;    <span class="comment">// 如果该目录项有效(P=1)(也即指定的页表在内存中)，则从中取得指定页表的地址-&gt;page_table。</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    <span class="keywordflow">if</span> ((*page_table) &amp; 1)</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;        page_table = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *) (0xfffff000 &amp; *page_table);</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;        <span class="comment">// 否则，申请空闲页面给页表使用，并在对应目录项中置相应标志7（User, U/S, R/W）。然后将</span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;        <span class="comment">// 该页表的地址??page_table。</span></div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;        <span class="keywordflow">if</span> (!(tmp = <a class="code" href="flash_2Linux-0_811_2mm_2memory_8c.html#af5beb0578c75971eb353cd8a67e9c042">get_free_page</a>()))</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;            <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;        *page_table = tmp | 7;</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;        page_table = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *) tmp;</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;    }</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    <span class="comment">// 在页表中设置指定地址的物理内存页面的页表项内容。每个页表共可有1024 项(0x3ff)。</span></div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;    page_table[(address &gt;&gt; 12) &amp; 0x3ff] = page | 7;</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    <span class="comment">// no need for invalidate</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;    <span class="comment">// 不需要刷新页变换高速缓冲</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    <span class="keywordflow">return</span> page;    <span class="comment">// 返回页面地址。</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="src_2mm_2memory_8c_ace386d1a75522ad316766aa6e3e9432e_cgraph.png" border="0" usemap="#asrc_2mm_2memory_8c_ace386d1a75522ad316766aa6e3e9432e_cgraph" alt=""/></div>
<map name="asrc_2mm_2memory_8c_ace386d1a75522ad316766aa6e3e9432e_cgraph" id="asrc_2mm_2memory_8c_ace386d1a75522ad316766aa6e3e9432e_cgraph">
<area shape="rect" title=" " alt="" coords="5,31,88,57"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#af5beb0578c75971eb353cd8a67e9c042" title=" " alt="" coords="136,5,251,32"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#a929c48d2c61fe71be34a9cdf0ab04fcc" title=" " alt="" coords="163,56,223,83"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2printk_8c.html#aaa83f2a89dae6d03dfe15deae29f383a" title=" " alt="" coords="299,56,371,83"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#ac2f4c669c6f6aa6caa5ab8adb1b07dd0" title=" " alt="" coords="423,5,495,32"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#a3fa7c8ef8597579301cb4b5c59bc6d9a" title=" " alt="" coords="419,56,500,83"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2string_8h.html#a2dee044e4e667b5b789b493abd21cfa4" title=" " alt="" coords="430,107,489,133"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="src_2mm_2memory_8c_ace386d1a75522ad316766aa6e3e9432e_icgraph.png" border="0" usemap="#asrc_2mm_2memory_8c_ace386d1a75522ad316766aa6e3e9432e_icgraph" alt=""/></div>
<map name="asrc_2mm_2memory_8c_ace386d1a75522ad316766aa6e3e9432e_icgraph" id="asrc_2mm_2memory_8c_ace386d1a75522ad316766aa6e3e9432e_icgraph">
<area shape="rect" title=" " alt="" coords="285,5,368,32"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2exec_8c.html#aa24f62422e3d5954cd9c8cba9f04ada5" title=" " alt="" coords="144,5,237,32"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2exec_8c.html#a91e86d0620f471b2fa1276658f635455" title=" " alt="" coords="5,5,96,32"/>
</map>
</div>

</div>
</div>
<a id="af17736024759f2f67c8a0e92edf49631"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af17736024759f2f67c8a0e92edf49631">&#9670;&nbsp;</a></span>share_page()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static int share_page </td>
          <td>(</td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>address</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="src_2mm_2memory_8c_source.html#l00495">495</a> of file <a class="el" href="src_2mm_2memory_8c_source.html">memory.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;                                             {</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;    <span class="keyword">struct </span><a class="code" href="structtask__struct.html">task_struct</a> **p;</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160; </div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    <span class="comment">// 如果是不可执行的，则返回。excutable 是执行进程的内存i 节点结构。</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#ae07dc9ad85faa82c21f0280346eee331">executable</a>)</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;    <span class="comment">// 如果只能单独执行(executable-&gt;i_count=1)，也退出。</span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#ae07dc9ad85faa82c21f0280346eee331">executable</a>-&gt;<a class="code" href="structm__inode.html#a2a639e88f4a46ff1bff2078aef2f6839">i_count</a> &lt; 2)</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;    <span class="comment">// 搜索任务数组中所有任务。寻找与当前进程可共享页面的进程，并尝试对指定地址的页面进行共享。</span></div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;    <span class="keywordflow">for</span> (p = &amp;<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#abc4ed73e97cde0df36d05d8075614f17">LAST_TASK</a>; p &gt; &amp;<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a34c8eecdb7a88d11553137a71d7c2cc3">FIRST_TASK</a>; --p) {</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;        <span class="keywordflow">if</span> (!*p)            <span class="comment">// 如果该任务项空闲，则继续寻找。</span></div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a> == *p)    <span class="comment">// 如果就是当前任务，也继续寻找。</span></div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;        <span class="keywordflow">if</span> ((*p)-&gt;executable != <a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#ae07dc9ad85faa82c21f0280346eee331">executable</a>)    <span class="comment">// 如果 executable 不等，也继续。</span></div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="src_2mm_2memory_8c.html#a03e623dabb773a2c0ae889137428ff8a">try_to_share</a>(address, *p))    <span class="comment">// 尝试共享页面。</span></div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;            <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;    }</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;}</div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2linux_2sched_8h_html_a34c8eecdb7a88d11553137a71d7c2cc3"><div class="ttname"><a href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a34c8eecdb7a88d11553137a71d7c2cc3">FIRST_TASK</a></div><div class="ttdeci">#define FIRST_TASK</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2sched_8h_source.html#l00007">sched.h:7</a></div></div>
<div class="ttc" id="aflash_2Linux-0_811_2include_2linux_2sched_8h_html_abc4ed73e97cde0df36d05d8075614f17"><div class="ttname"><a href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#abc4ed73e97cde0df36d05d8075614f17">LAST_TASK</a></div><div class="ttdeci">#define LAST_TASK</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2sched_8h_source.html#l00008">sched.h:8</a></div></div>
<div class="ttc" id="asrc_2mm_2memory_8c_html_a03e623dabb773a2c0ae889137428ff8a"><div class="ttname"><a href="src_2mm_2memory_8c.html#a03e623dabb773a2c0ae889137428ff8a">try_to_share</a></div><div class="ttdeci">static int try_to_share(unsigned long address, struct task_struct *p)</div><div class="ttdef"><b>Definition:</b> <a href="src_2mm_2memory_8c_source.html#l00419">memory.c:419</a></div></div>
<div class="ttc" id="astructm__inode_html_a2a639e88f4a46ff1bff2078aef2f6839"><div class="ttname"><a href="structm__inode.html#a2a639e88f4a46ff1bff2078aef2f6839">m_inode::i_count</a></div><div class="ttdeci">unsigned short i_count</div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2fs_8h_source.html#l00107">fs.h:107</a></div></div>
<div class="ttc" id="astructtask__struct_html"><div class="ttname"><a href="structtask__struct.html">task_struct</a></div><div class="ttdef"><b>Definition:</b> <a href="flash_2Linux-0_811_2include_2linux_2sched_8h_source.html#l00080">sched.h:80</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="src_2mm_2memory_8c_af17736024759f2f67c8a0e92edf49631_cgraph.png" border="0" usemap="#asrc_2mm_2memory_8c_af17736024759f2f67c8a0e92edf49631_cgraph" alt=""/></div>
<map name="asrc_2mm_2memory_8c_af17736024759f2f67c8a0e92edf49631_cgraph" id="asrc_2mm_2memory_8c_af17736024759f2f67c8a0e92edf49631_cgraph">
<area shape="rect" title=" " alt="" coords="5,56,103,83"/>
<area shape="rect" href="src_2mm_2memory_8c.html#a03e623dabb773a2c0ae889137428ff8a" title=" " alt="" coords="151,56,253,83"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#af5beb0578c75971eb353cd8a67e9c042" title=" " alt="" coords="301,5,416,32"/>
<area shape="rect" href="src_2mm_2memory_8c.html#a8bc8685c6eebde3509bd55c7cf73e6d6" title=" " alt="" coords="333,56,384,83"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#ab43c5eded9a063f60e583332eaa73258" title=" " alt="" coords="330,107,387,133"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#ad6b4534f17cfa3172ef7d563e8fda5f2" title=" " alt="" coords="469,31,540,57"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#a929c48d2c61fe71be34a9cdf0ab04fcc" title=" " alt="" coords="475,81,535,108"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2printk_8c.html#aaa83f2a89dae6d03dfe15deae29f383a" title=" " alt="" coords="593,81,665,108"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#ac2f4c669c6f6aa6caa5ab8adb1b07dd0" title=" " alt="" coords="718,31,790,57"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#a3fa7c8ef8597579301cb4b5c59bc6d9a" title=" " alt="" coords="713,81,795,108"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2string_8h.html#a2dee044e4e667b5b789b493abd21cfa4" title=" " alt="" coords="725,132,783,159"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2panic_8c.html#acc81aedafa96378bafb37b5bccbccb20" title=" " alt="" coords="464,132,545,159"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="src_2mm_2memory_8c_af17736024759f2f67c8a0e92edf49631_icgraph.png" border="0" usemap="#asrc_2mm_2memory_8c_af17736024759f2f67c8a0e92edf49631_icgraph" alt=""/></div>
<map name="asrc_2mm_2memory_8c_af17736024759f2f67c8a0e92edf49631_icgraph" id="asrc_2mm_2memory_8c_af17736024759f2f67c8a0e92edf49631_icgraph">
<area shape="rect" title=" " alt="" coords="153,5,251,32"/>
<area shape="rect" href="src_2mm_2memory_8c.html#a55531a8e8bf5db98f751b376994ded87" title=" " alt="" coords="5,5,105,32"/>
</map>
</div>

</div>
</div>
<a id="a03e623dabb773a2c0ae889137428ff8a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a03e623dabb773a2c0ae889137428ff8a">&#9670;&nbsp;</a></span>try_to_share()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static int try_to_share </td>
          <td>(</td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>address</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structtask__struct.html">task_struct</a> *&#160;</td>
          <td class="paramname"><em>p</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="src_2mm_2memory_8c_source.html#l00419">419</a> of file <a class="el" href="src_2mm_2memory_8c_source.html">memory.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;                                                                      {</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> from;</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> to;</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> from_page;</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> to_page;</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> phys_addr;</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160; </div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;    <span class="comment">// 求指定内存地址的页目录项。</span></div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    from_page = to_page = ((address &gt;&gt; 20) &amp; 0xffc);</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    <span class="comment">// 计算进程p 的代码起始地址所对应的页目录项。</span></div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;    from_page += ((p-&gt;<a class="code" href="structtask__struct.html#a24d9b9a967501adbc9ef96dde3ae3cbd">start_code</a> &gt;&gt; 20) &amp; 0xffc);</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;    <span class="comment">// 计算当前进程中代码起始地址所对应的页目录项。</span></div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    to_page += ((<a class="code" href="flash_2Linux-0_811_2include_2linux_2sched_8h.html#a476ec09a598028a09942c2233aa5127e">current</a>-&gt;<a class="code" href="structtask__struct.html#a24d9b9a967501adbc9ef96dde3ae3cbd">start_code</a> &gt;&gt; 20) &amp; 0xffc);</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    <span class="comment">// is there a page-directory at from?</span></div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;    <span class="comment">// 在from 处是否存在页目录？</span></div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    <span class="comment">// *** 对 p 进程页面进行操作。</span></div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;    <span class="comment">// 取页目录项内容。如果该目录项无效(P=0)，则返回。否则取该目录项对应页表地址-&gt;from。</span></div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;    from = *(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *) from_page;</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;    <span class="keywordflow">if</span> (!(from &amp; 1))</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;    from &amp;= 0xfffff000;</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;    <span class="comment">// 计算地址对应的页表项指针值，并取出该页表项内容??phys_addr。</span></div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;    from_page = from + ((address &gt;&gt; 10) &amp; 0xffc);</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;    phys_addr = *(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *) from_page;</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;    <span class="comment">// is the page clean and present?</span></div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;    <span class="comment">// 页面干净并且存在吗?</span></div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;    <span class="comment">// 0x41 对应页表项中的 Dirty 和 Present 标志。如果页面不干净或无效则返回。</span></div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;    <span class="keywordflow">if</span> ((phys_addr &amp; 0x41) != 0x01)</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    <span class="comment">// 取页面的地址-&gt;phys_addr。如果该页面地址不存在或小于内存低端(1M)也返回退出。</span></div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;    phys_addr &amp;= 0xfffff000;</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;    <span class="keywordflow">if</span> (phys_addr &gt;= <a class="code" href="src_2mm_2memory_8c.html#a9838fae7bc8607f03ff29cfd191441c7">HIGH_MEMORY</a> || phys_addr &lt; <a class="code" href="src_2mm_2memory_8c.html#a33546c633e25fbc31ba28c4419b37af4">LOW_MEM</a>)</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;    <span class="comment">// *** 对当前进程页面进行操作。</span></div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;    <span class="comment">// 取页目录项内容-&gt;to。如果该目录项无效(P=0)，则取空闲页面，并更新 to_page 所指的目录项。</span></div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;    to = *(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *) to_page;</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;    <span class="keywordflow">if</span> (!(to &amp; 1))</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;        <span class="keywordflow">if</span> (to = <a class="code" href="flash_2Linux-0_811_2mm_2memory_8c.html#af5beb0578c75971eb353cd8a67e9c042">get_free_page</a>())</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;            *(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *) to_page = to | 7;</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;            <a class="code" href="src_2mm_2memory_8c.html#a8bc8685c6eebde3509bd55c7cf73e6d6">oom</a>();</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;    <span class="comment">// 取对应页表地址-&gt;to，页表项地址-&gt;to_page。如果对应的页面已经存在，则出错，死机。</span></div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;    to &amp;= 0xfffff000;</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;    to_page = to + ((address &gt;&gt; 10) &amp; 0xffc);</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;    <span class="keywordflow">if</span> (1 &amp; *(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *) to_page)</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;        <a class="code" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#ab43c5eded9a063f60e583332eaa73258">panic</a>(<span class="stringliteral">&quot;try_to_share: to_page already exists&quot;</span>);</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;    <span class="comment">// share them: write-protect</span></div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;    <span class="comment">// 对它们进行共享处理：写保护</span></div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;    <span class="comment">// 对 p 进程中页面置写保护标志(置 R/W=0 只读)。并且当前进程中的对应页表项指向它。</span></div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    *(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *) from_page &amp;= ~2;</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;    *(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *) to_page = *(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *) from_page;</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    <span class="comment">// 刷新页变换高速缓冲。</span></div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    <a class="code" href="src_2mm_2memory_8c.html#acf7d1d4e3ad496402dd3b5fbe365105d">invalidate</a>();</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    <span class="comment">// 计算所操作页面的页面号，并将对应页面映射数组项中的引用递增1。</span></div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;    phys_addr -= <a class="code" href="src_2mm_2memory_8c.html#a33546c633e25fbc31ba28c4419b37af4">LOW_MEM</a>;</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    phys_addr &gt;&gt;= 12;</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    <a class="code" href="src_2mm_2memory_8c.html#a55d0a3018dfecd08963844523d3d4b64">mem_map</a>[phys_addr]++;</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;    <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="src_2mm_2memory_8c_a03e623dabb773a2c0ae889137428ff8a_cgraph.png" border="0" usemap="#asrc_2mm_2memory_8c_a03e623dabb773a2c0ae889137428ff8a_cgraph" alt=""/></div>
<map name="asrc_2mm_2memory_8c_a03e623dabb773a2c0ae889137428ff8a_cgraph" id="asrc_2mm_2memory_8c_a03e623dabb773a2c0ae889137428ff8a_cgraph">
<area shape="rect" title=" " alt="" coords="5,56,108,83"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#af5beb0578c75971eb353cd8a67e9c042" title=" " alt="" coords="156,5,271,32"/>
<area shape="rect" href="src_2mm_2memory_8c.html#a8bc8685c6eebde3509bd55c7cf73e6d6" title=" " alt="" coords="188,56,239,83"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#ab43c5eded9a063f60e583332eaa73258" title=" " alt="" coords="185,107,242,133"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#ad6b4534f17cfa3172ef7d563e8fda5f2" title=" " alt="" coords="324,31,395,57"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#a929c48d2c61fe71be34a9cdf0ab04fcc" title=" " alt="" coords="329,81,389,108"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2printk_8c.html#aaa83f2a89dae6d03dfe15deae29f383a" title=" " alt="" coords="448,81,520,108"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#ac2f4c669c6f6aa6caa5ab8adb1b07dd0" title=" " alt="" coords="573,31,645,57"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#a3fa7c8ef8597579301cb4b5c59bc6d9a" title=" " alt="" coords="568,81,649,108"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2string_8h.html#a2dee044e4e667b5b789b493abd21cfa4" title=" " alt="" coords="579,132,638,159"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2panic_8c.html#acc81aedafa96378bafb37b5bccbccb20" title=" " alt="" coords="319,132,400,159"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="src_2mm_2memory_8c_a03e623dabb773a2c0ae889137428ff8a_icgraph.png" border="0" usemap="#asrc_2mm_2memory_8c_a03e623dabb773a2c0ae889137428ff8a_icgraph" alt=""/></div>
<map name="asrc_2mm_2memory_8c_a03e623dabb773a2c0ae889137428ff8a_icgraph" id="asrc_2mm_2memory_8c_a03e623dabb773a2c0ae889137428ff8a_icgraph">
<area shape="rect" title=" " alt="" coords="299,5,401,32"/>
<area shape="rect" href="src_2mm_2memory_8c.html#af17736024759f2f67c8a0e92edf49631" title=" " alt="" coords="153,5,251,32"/>
<area shape="rect" href="src_2mm_2memory_8c.html#a55531a8e8bf5db98f751b376994ded87" title=" " alt="" coords="5,5,105,32"/>
</map>
</div>

</div>
</div>
<a id="a7beb786b07c313c61111c5709391f3d3"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7beb786b07c313c61111c5709391f3d3">&#9670;&nbsp;</a></span>un_wp_page()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void un_wp_page </td>
          <td>(</td>
          <td class="paramtype">unsigned long *&#160;</td>
          <td class="paramname"><em>table_entry</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="src_2mm_2memory_8c_source.html#l00312">312</a> of file <a class="el" href="src_2mm_2memory_8c_source.html">memory.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;                                            {</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> old_page, new_page;</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160; </div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    old_page = 0xfffff000 &amp; *table_entry;    <span class="comment">// 取原页面对应的目录项号。</span></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    <span class="comment">// 如果原页面地址大于内存低端 LOW_MEM(1Mb)，并且其在页面映射字节图数组中值为 1（表示仅</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    <span class="comment">// 被引用 1 次，页面没有被共享），则在该页面的页表项中置 R/W 标志（可写），并刷新页变换</span></div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    <span class="comment">// 高速缓冲，然后返回。</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    <span class="keywordflow">if</span> (old_page &gt;= <a class="code" href="src_2mm_2memory_8c.html#a33546c633e25fbc31ba28c4419b37af4">LOW_MEM</a> &amp;&amp; <a class="code" href="src_2mm_2memory_8c.html#a55d0a3018dfecd08963844523d3d4b64">mem_map</a>[<a class="code" href="src_2mm_2memory_8c.html#a5a6ea6599d09c9ce1d393125c30965ca">MAP_NR</a>(old_page)] == 1) {</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;        *table_entry |= 2;</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;        <a class="code" href="src_2mm_2memory_8c.html#acf7d1d4e3ad496402dd3b5fbe365105d">invalidate</a>();</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    }</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    <span class="comment">// 否则，在主内存区内申请一页空闲页面。</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    <span class="keywordflow">if</span> (!(new_page = <a class="code" href="flash_2Linux-0_811_2mm_2memory_8c.html#af5beb0578c75971eb353cd8a67e9c042">get_free_page</a>()))</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;        <a class="code" href="src_2mm_2memory_8c.html#a8bc8685c6eebde3509bd55c7cf73e6d6">oom</a>();            <span class="comment">// Out of Memory。内存不够处理。</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    <span class="comment">// 如果原页面大于内存低端（则意味着 mem_map[]&gt;1，页面是共享的），则将原页面的页面映射</span></div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    <span class="comment">// 数组值递减 1。然后将指定页表项内容更新为新页面的地址，并置可读写等标志(U/S, R/W, P)。</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    <span class="comment">// 刷新页变换高速缓冲。最后将原页面内容复制到新页面。</span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    <span class="keywordflow">if</span> (old_page &gt;= <a class="code" href="src_2mm_2memory_8c.html#a33546c633e25fbc31ba28c4419b37af4">LOW_MEM</a>)</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;        <a class="code" href="src_2mm_2memory_8c.html#a55d0a3018dfecd08963844523d3d4b64">mem_map</a>[<a class="code" href="src_2mm_2memory_8c.html#a5a6ea6599d09c9ce1d393125c30965ca">MAP_NR</a>(old_page)]--;</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    *table_entry = new_page | 7;</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    <a class="code" href="src_2mm_2memory_8c.html#acf7d1d4e3ad496402dd3b5fbe365105d">invalidate</a>();</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    <a class="code" href="src_2mm_2memory_8c.html#ae2f19afb3504df27b0e517884cd3b549">copy_page</a>(old_page, new_page);</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;}</div>
<div class="ttc" id="asrc_2mm_2memory_8c_html_ae2f19afb3504df27b0e517884cd3b549"><div class="ttname"><a href="src_2mm_2memory_8c.html#ae2f19afb3504df27b0e517884cd3b549">copy_page</a></div><div class="ttdeci">#define copy_page(from, to)</div><div class="ttdef"><b>Definition:</b> <a href="src_2mm_2memory_8c_source.html#l00066">memory.c:66</a></div></div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="src_2mm_2memory_8c_a7beb786b07c313c61111c5709391f3d3_cgraph.png" border="0" usemap="#asrc_2mm_2memory_8c_a7beb786b07c313c61111c5709391f3d3_cgraph" alt=""/></div>
<map name="asrc_2mm_2memory_8c_a7beb786b07c313c61111c5709391f3d3_cgraph" id="asrc_2mm_2memory_8c_a7beb786b07c313c61111c5709391f3d3_cgraph">
<area shape="rect" title=" " alt="" coords="5,31,108,57"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#af5beb0578c75971eb353cd8a67e9c042" title=" " alt="" coords="156,5,271,32"/>
<area shape="rect" href="src_2mm_2memory_8c.html#a8bc8685c6eebde3509bd55c7cf73e6d6" title=" " alt="" coords="188,56,239,83"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#ad6b4534f17cfa3172ef7d563e8fda5f2" title=" " alt="" coords="319,31,389,57"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#a929c48d2c61fe71be34a9cdf0ab04fcc" title=" " alt="" coords="324,81,384,108"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2printk_8c.html#aaa83f2a89dae6d03dfe15deae29f383a" title=" " alt="" coords="437,81,509,108"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#ac2f4c669c6f6aa6caa5ab8adb1b07dd0" title=" " alt="" coords="562,31,634,57"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#a3fa7c8ef8597579301cb4b5c59bc6d9a" title=" " alt="" coords="557,81,639,108"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2string_8h.html#a2dee044e4e667b5b789b493abd21cfa4" title=" " alt="" coords="569,132,627,159"/>
</map>
</div>

</div>
</div>
<a id="abe18d0a2e79d311f52c8c127665239d6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abe18d0a2e79d311f52c8c127665239d6">&#9670;&nbsp;</a></span>write_verify()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void write_verify </td>
          <td>(</td>
          <td class="paramtype">unsigned long&#160;</td>
          <td class="paramname"><em>address</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="src_2mm_2memory_8c_source.html#l00373">373</a> of file <a class="el" href="src_2mm_2memory_8c_source.html">memory.c</a>.</p>
<div class="fragment"><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;                                         {</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> page;</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160; </div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;    <span class="comment">// 判断指定地址所对应页目录项的页表是否存在(P)，若不存在(P=0)则返回。</span></div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    <span class="keywordflow">if</span> (!((page = *((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *) ((address &gt;&gt; 20) &amp; 0xffc))) &amp; 1))</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    <span class="comment">// 取页表的地址，加上指定地址的页面在页表中的页表项偏移值，得对应物理页面的页表项指针。</span></div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;    page &amp;= 0xfffff000;</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;    page += ((address &gt;&gt; 10) &amp; 0xffc);</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    <span class="comment">// 如果该页面不可写(标志 R/W 没有置位)，则执行共享检验和复制页面操作（写时复制）。</span></div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    <span class="keywordflow">if</span> ((3 &amp; *(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *) page) == 1)    <span class="comment">// non-writeable, present</span></div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;        <a class="code" href="flash_2Linux-0_811_2mm_2memory_8c.html#a7beb786b07c313c61111c5709391f3d3">un_wp_page</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> *) page);</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;}</div>
</div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="src_2mm_2memory_8c_abe18d0a2e79d311f52c8c127665239d6_cgraph.png" border="0" usemap="#asrc_2mm_2memory_8c_abe18d0a2e79d311f52c8c127665239d6_cgraph" alt=""/></div>
<map name="asrc_2mm_2memory_8c_abe18d0a2e79d311f52c8c127665239d6_cgraph" id="asrc_2mm_2memory_8c_abe18d0a2e79d311f52c8c127665239d6_cgraph">
<area shape="rect" title=" " alt="" coords="5,31,104,57"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#a7beb786b07c313c61111c5709391f3d3" title=" " alt="" coords="152,31,255,57"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#af5beb0578c75971eb353cd8a67e9c042" title=" " alt="" coords="303,5,417,32"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#a8bc8685c6eebde3509bd55c7cf73e6d6" title=" " alt="" coords="335,56,385,83"/>
<area shape="rect" href="flash_2Linux-0_811_2mm_2memory_8c.html#ad6b4534f17cfa3172ef7d563e8fda5f2" title=" " alt="" coords="465,31,536,57"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#a929c48d2c61fe71be34a9cdf0ab04fcc" title=" " alt="" coords="471,81,531,108"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2printk_8c.html#aaa83f2a89dae6d03dfe15deae29f383a" title=" " alt="" coords="584,81,656,108"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#ac2f4c669c6f6aa6caa5ab8adb1b07dd0" title=" " alt="" coords="709,31,781,57"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2vsprintf_8c.html#a3fa7c8ef8597579301cb4b5c59bc6d9a" title=" " alt="" coords="704,81,785,108"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2string_8h.html#a2dee044e4e667b5b789b493abd21cfa4" title=" " alt="" coords="715,132,774,159"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="src_2mm_2memory_8c_abe18d0a2e79d311f52c8c127665239d6_icgraph.png" border="0" usemap="#asrc_2mm_2memory_8c_abe18d0a2e79d311f52c8c127665239d6_icgraph" alt=""/></div>
<map name="asrc_2mm_2memory_8c_abe18d0a2e79d311f52c8c127665239d6_icgraph" id="asrc_2mm_2memory_8c_abe18d0a2e79d311f52c8c127665239d6_icgraph">
<area shape="rect" title=" " alt="" coords="455,284,553,311"/>
<area shape="rect" href="flash_2Linux-0_811_2include_2linux_2kernel_8h.html#afc318b86ebf9e88f5af7ca7077098a7f" title=" " alt="" coords="312,284,407,311"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2stat_8c.html#ae9bbfad9a19a302b82cf82046bbb524e" title=" " alt="" coords="179,31,249,57"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2signal_8c.html#a06c58d4276ef5e9e8c96309b3b635613" title=" " alt="" coords="172,81,256,108"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2chr__drv_2tty__ioctl_8c.html#a329f7cc69ddf54c9ed0b15bd39ce33d8" title=" " alt="" coords="167,132,261,159"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2ioctl_8c.html#a709d61416c8ec6675ca795d62495a3ae" title=" " alt="" coords="23,183,98,209"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2chr__drv_2tty__ioctl_8c.html#a3999b4bae89c857b1742c230d023b7c0" title=" " alt="" coords="164,233,264,260"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2signal_8c.html#a4ac17838628ac8773a5c99d8293d7c0d" title=" " alt="" coords="174,284,254,311"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2read__write_8c.html#a8ace77218f609b6282577c9cb3a8cac5" title=" " alt="" coords="174,335,254,361"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2sys_8c.html#a944189ed10ed5a3ba57f0fbd09f5e79b" title=" " alt="" coords="173,385,255,412"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2sys_8c.html#ab12535d66aaba5404b7101d381a43b36" title=" " alt="" coords="170,436,258,463"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2sys_8c.html#a45548e3c78799983a4fd25f7d50094c3" title=" " alt="" coords="166,487,262,513"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2exit_8c.html#a69163056b363c343e0467605762db26c" title=" " alt="" coords="165,537,263,564"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2stat_8c.html#a116c0c99bed8d1246fe4ad85421b14c5" title=" " alt="" coords="20,5,101,32"/>
<area shape="rect" href="flash_2Linux-0_811_2fs_2stat_8c.html#a8d4a37bb6cbbf7fe6db13504f67d9234" title=" " alt="" coords="23,56,99,83"/>
<area shape="rect" href="flash_2Linux-0_811_2kernel_2signal_8c.html#ad631f34ef5e519a7bc9232a66aa43fbc" title=" " alt="" coords="5,284,116,311"/>
</map>
</div>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a9838fae7bc8607f03ff29cfd191441c7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9838fae7bc8607f03ff29cfd191441c7">&#9670;&nbsp;</a></span>HIGH_MEMORY</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">long HIGH_MEMORY = 0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="src_2mm_2memory_8c_source.html#l00063">63</a> of file <a class="el" href="src_2mm_2memory_8c_source.html">memory.c</a>.</p>

</div>
</div>
<a id="a55d0a3018dfecd08963844523d3d4b64"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a55d0a3018dfecd08963844523d3d4b64">&#9670;&nbsp;</a></span>mem_map</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">unsigned char mem_map[<a class="el" href="src_2mm_2memory_8c.html#a1843924b1500f8e01c5fc255b02088d2">PAGING_PAGES</a>] = {0,}</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="src_2mm_2memory_8c_source.html#l00070">70</a> of file <a class="el" href="src_2mm_2memory_8c_source.html">memory.c</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_ab09485bdc122e425bd6417e92d7acba.html">mm</a></li><li class="navelem"><a class="el" href="src_2mm_2memory_8c.html">memory.c</a></li>
    <li class="footer">Generated on Wed Sep 13 2023 00:50:58 for linux by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
